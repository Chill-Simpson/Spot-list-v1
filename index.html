<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¹ãƒãƒƒãƒˆç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ç‰ˆï¼‰</title>
  <link rel="stylesheet" href="spot-style.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2A3A38">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ã‚¹ãƒãƒƒãƒˆç®¡ç†">
  <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
  <style>
    /* ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .filter-input {
      width: 90%;
      max-width: 800px;
      padding: 10px 14px;
      font-size: 16px;
      border: 1px solid #2A4A46;
      border-radius: 8px;
      background: #3A5A56;
      color: #ffffff;
      margin: 10px auto;
      display: block;
    }
    
    .filter-input::placeholder {
      color: #aaa;
    }
    
    /* ã‚«ãƒ¼ãƒ‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
    .card-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¸‹å±¤ã«é€šéã•ã›ã‚‹ */
      border-radius: 14px; /* ã‚«ãƒ¼ãƒ‰ã¨åŒã˜è§’ä¸¸ã« */
    }

    /* è‡ªè»ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ - ã‚ˆã‚Šæ¿ƒã„ç·‘è‰² */
    .overlay-green {
      background-color: rgba(0, 70, 0, 0.65); /* ã‚ˆã‚Šæ¿ƒã„ç·‘è‰² */
      box-shadow: inset 0 0 0 3px rgba(46, 204, 113, 0.9); /* å†…å´ã®æ ç·š */
    }

    /* æ•µè»ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ - ã‚ˆã‚Šæ¿ƒã„èµ¤è‰² */
    .overlay-red {
      background-color: rgba(100, 0, 0, 0.65); /* ã‚ˆã‚Šæ¿ƒã„èµ¤è‰² */
      box-shadow: inset 0 0 0 3px rgba(231, 76, 60, 0.9); /* å†…å´ã®æ ç·š */
    }

    /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒã‚ã‚‹å ´åˆã€ãƒãƒƒã‚¸ã®z-indexã‚’ä¸Šã’ã‚‹ */
    .badge {
      z-index: 3; /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚ˆã‚Šã‚‚å‰é¢ã« */
    }

    .pref-tag {
      z-index: 3; /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚ˆã‚Šã‚‚å‰é¢ã« */
    }
    
    /* ãƒ¬ãƒ™ãƒ«ãƒãƒƒã‚¸ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« - æ·±ç·‘ã®é»’èƒŒæ™¯ã«å¤‰æ›´ */
    .badge.level {
      background-color: rgba(22, 33, 30, 0.85); /* ç”»åƒã®æ·±ç·‘ã£ã½ã„é»’è‰² */
      color: white; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ–‡å­—è‰² */
      border: 1px solid rgba(255, 255, 255, 0.2); /* å¾®ã‹ãªå¢ƒç•Œç·š */
    }
    
    /* ãƒ¬ãƒ™ãƒ«åˆ¥ã®æ–‡å­—è‰² */
    .badge.level.s-rank { color: #FF5252; } /* S - èµ¤è‰² */
    .badge.level.a-rank { color: #BB86FC; } /* A - ç´«è‰² */
    .badge.level.b-rank { color: #3D5AFE; } /* B - é’è‰² */
    .badge.level.c-rank { color: #00E5B9; } /* C - ãƒŸãƒ³ãƒˆè‰² */
    .badge.level.d-rank { color: #E0E0E0; } /* D - ç™½/ã‚°ãƒ¬ãƒ¼è‰² */
    
    /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .error-message {
      color: #ffdddd; /* ã‚„ã‚„æ˜ã‚‹ã„èµ¤æ–‡å­— */
      text-align: center;
      padding: 24px 16px;
      font-size: 1em;
    }
    
    /* æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«: å¿…é ˆé …ç›®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .modal label .required-indicator {
      color: #e74c3c; /* ã‚„ã‚„æ¿ƒã„èµ¤è‰² */
      font-weight: bold; /* å¤ªå­—ã«ã™ã‚‹ */
      margin-right: 8px; /* ã€Œã€å¿…é ˆã€‘ã€ã¨ãƒ©ãƒ™ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã®é–“ã«å°‘ã—éš™é–“ã‚’ç©ºã‘ã‚‹ */
    }
  </style>
  <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« -->
  <style>
    /* ãƒšãƒ¼ã‚¸æœ¬ä½“ãŒã‚¿ãƒ–ã«éš ã‚Œãªã„ã‚ˆã†ã«ä¸‹éƒ¨ã«ä½™ç™½ã‚’ä½œã‚‹ */
    body {
      /* ä»–ã® body ã‚¹ã‚¿ã‚¤ãƒ«ãŒã‚ã‚Œã°ç¶­æŒ */
      padding-bottom: 60px; /* ã‚¿ãƒ–ã®é«˜ã•åˆ†+Î± ã®ä½™ç™½ã‚’ç¢ºä¿ */
    }

    .bottom-nav {
      position: fixed; /* ç”»é¢ä¸‹éƒ¨ã«å›ºå®š */
      bottom: 0;
      left: 0;
      width: 100%;
      height: 50px; /* ã‚¿ãƒ–ã®é«˜ã•ã‚’æŒ‡å®š */
      background-color: #2A3A38; /* èƒŒæ™¯è‰² (ä»–ã®è¦ç´ ã¨åˆã‚ã›ã‚‹) */
      border-top: 1px solid rgba(255, 255, 255, 0.1); /* ä¸Šå¢ƒç•Œç·š */
      display: flex; /* ã‚¿ãƒ–ã‚’æ¨ªä¸¦ã³ã« */
      justify-content: space-around; /* ã‚¿ãƒ–é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‡ç­‰ã« */
      align-items: center; /* ä¸Šä¸‹ä¸­å¤®æƒãˆ */
      box-shadow: 0 -2px 5px rgba(0,0,0,0.2); /* ä¸Šå‘ãã®å½± */
      z-index: 1100; /* ä»–ã®è¦ç´ ã‚ˆã‚Šæ‰‹å‰ã« */
    }

    .nav-item {
      display: flex;
      flex-direction: column; /* ãƒ†ã‚­ã‚¹ãƒˆ (ã‚„ã‚¢ã‚¤ã‚³ãƒ³) ã‚’ç¸¦ã«ç©ã‚€å ´åˆ */
      align-items: center; /* ä¸­å¤®æƒãˆ */
      justify-content: center; /* ä¸­å¤®æƒãˆ */
      flex-grow: 1; /* å„ã‚¿ãƒ–ãŒå‡ç­‰ã«å¹…ã‚’å–ã‚‹ */
      height: 100%;
      color: #aaa; /* é€šå¸¸æ™‚ã®ãƒ†ã‚­ã‚¹ãƒˆè‰² */
      text-decoration: none; /* ãƒªãƒ³ã‚¯ã®ä¸‹ç·šã‚’æ¶ˆã™ */
      text-align: center;
      padding: 4px 0; /* ä¸Šä¸‹ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
      transition: color 0.2s; /* è‰²å¤‰åŒ–ã‚’æ»‘ã‚‰ã‹ã« */
    }

    .nav-item:hover {
      color: #fff; /* ãƒ›ãƒãƒ¼æ™‚ã®è‰² */
    }

    .nav-text {
      font-size: 12px; /* ãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚º */
      margin-top: 2px; /* ã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒ†ã‚­ã‚¹ãƒˆã®é–“éš” (ã‚¢ã‚¤ã‚³ãƒ³ãŒãªã„å ´åˆã¯èª¿æ•´) */
    }

    /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .nav-item.active {
      color: #2ecc71; /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã®è‰² (ä¾‹: ç·‘) */
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1 class="page-title">Spot list</h1>
  <button class="open-btn" id="openModal">ï¼‹</button>

  <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <nav class="bottom-nav">
    <a href="index.html" class="nav-item active" id="nav-list">
      <span class="nav-text">ãƒªã‚¹ãƒˆ</span>
    </a>
    <a href="map_view.html" class="nav-item" id="nav-map">
      <span class="nav-text">ãƒãƒƒãƒ—</span>
    </a>
    <a href="sort_spots.html" class="nav-item" id="nav-sort">
      <span class="nav-text">ä¸¦ã³æ›¿ãˆ</span>
    </a>
  </nav>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ -->
  <div class="filter-container">
    <!-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã‚’1è¡Œç›®ã«å˜ç‹¬ã§é…ç½® -->
    <div class="filter-row">
      <div class="filter-item keyword-item">
        <label for="keywordFilter" class="filter-label">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼š</label>
        <input type="text" id="keywordFilter" class="filter-input" placeholder="ã‚¹ãƒãƒƒãƒˆã€ä½æ‰€ã€ç™»éŒ²è€…åã§æ¤œç´¢å¯èƒ½">
      </div>
    </div>
    
    <!-- 2è¡Œç›®ã«éƒ½é“åºœçœŒã¨ã‚®ãƒ«ãƒ‰çŠ¶æ³ã‚’é…ç½® -->
    <div class="filter-row">
      <div class="filter-item">
        <label for="prefectureFilter" class="filter-label">éƒ½é“åºœçœŒ</label>
        <select id="prefectureFilter" class="filter-select">
          <option value="">ã™ã¹ã¦è¡¨ç¤º</option>
          <option value="åŒ—æµ·é“">åŒ—æµ·é“</option>
          <option value="é’æ£®çœŒ">é’æ£®çœŒ</option>
          <option value="å²©æ‰‹çœŒ">å²©æ‰‹çœŒ</option>
          <option value="å®®åŸçœŒ">å®®åŸçœŒ</option>
          <option value="ç§‹ç”°çœŒ">ç§‹ç”°çœŒ</option>
          <option value="å±±å½¢çœŒ">å±±å½¢çœŒ</option>
          <option value="ç¦å³¶çœŒ">ç¦å³¶çœŒ</option>
          <option value="èŒ¨åŸçœŒ">èŒ¨åŸçœŒ</option>
          <option value="æ ƒæœ¨çœŒ">æ ƒæœ¨çœŒ</option>
          <option value="ç¾¤é¦¬çœŒ">ç¾¤é¦¬çœŒ</option>
          <option value="åŸ¼ç‰çœŒ">åŸ¼ç‰çœŒ</option>
          <option value="åƒè‘‰çœŒ">åƒè‘‰çœŒ</option>
          <option value="æ±äº¬éƒ½">æ±äº¬éƒ½</option>
          <option value="ç¥å¥ˆå·çœŒ">ç¥å¥ˆå·çœŒ</option>
          <option value="æ–°æ½ŸçœŒ">æ–°æ½ŸçœŒ</option>
          <option value="å¯Œå±±çœŒ">å¯Œå±±çœŒ</option>
          <option value="çŸ³å·çœŒ">çŸ³å·çœŒ</option>
          <option value="ç¦äº•çœŒ">ç¦äº•çœŒ</option>
          <option value="å±±æ¢¨çœŒ">å±±æ¢¨çœŒ</option>
          <option value="é•·é‡çœŒ">é•·é‡çœŒ</option>
          <option value="å²é˜œçœŒ">å²é˜œçœŒ</option>
          <option value="é™å²¡çœŒ">é™å²¡çœŒ</option>
          <option value="æ„›çŸ¥çœŒ">æ„›çŸ¥çœŒ</option>
          <option value="ä¸‰é‡çœŒ">ä¸‰é‡çœŒ</option>
          <option value="æ»‹è³€çœŒ">æ»‹è³€çœŒ</option>
          <option value="äº¬éƒ½åºœ">äº¬éƒ½åºœ</option>
          <option value="å¤§é˜ªåºœ">å¤§é˜ªåºœ</option>
          <option value="å…µåº«çœŒ">å…µåº«çœŒ</option>
          <option value="å¥ˆè‰¯çœŒ">å¥ˆè‰¯çœŒ</option>
          <option value="å’Œæ­Œå±±çœŒ">å’Œæ­Œå±±çœŒ</option>
          <option value="é³¥å–çœŒ">é³¥å–çœŒ</option>
          <option value="å³¶æ ¹çœŒ">å³¶æ ¹çœŒ</option>
          <option value="å²¡å±±çœŒ">å²¡å±±çœŒ</option>
          <option value="åºƒå³¶çœŒ">åºƒå³¶çœŒ</option>
          <option value="å±±å£çœŒ">å±±å£çœŒ</option>
          <option value="å¾³å³¶çœŒ">å¾³å³¶çœŒ</option>
          <option value="é¦™å·çœŒ">é¦™å·çœŒ</option>
          <option value="æ„›åª›çœŒ">æ„›åª›çœŒ</option>
          <option value="é«˜çŸ¥çœŒ">é«˜çŸ¥çœŒ</option>
          <option value="ç¦å²¡çœŒ">ç¦å²¡çœŒ</option>
          <option value="ä½è³€çœŒ">ä½è³€çœŒ</option>
          <option value="é•·å´çœŒ">é•·å´çœŒ</option>
          <option value="ç†Šæœ¬çœŒ">ç†Šæœ¬çœŒ</option>
          <option value="å¤§åˆ†çœŒ">å¤§åˆ†çœŒ</option>
          <option value="å®®å´çœŒ">å®®å´çœŒ</option>
          <option value="é¹¿å…å³¶çœŒ">é¹¿å…å³¶çœŒ</option>
          <option value="æ²–ç¸„çœŒ">æ²–ç¸„çœŒ</option>
        </select>
      </div>

      <div class="filter-item">
        <label for="teamFilter" class="filter-label">ã‚®ãƒ«ãƒ‰çŠ¶æ³</label>
        <select id="teamFilter" class="filter-select">
          <option value="">ã™ã¹ã¦è¡¨ç¤º</option>
          <option value="your guild">è‡ªã‚®ãƒ«ãƒ‰</option>
          <option value="enemy">æ•µã‚®ãƒ«ãƒ‰</option>
          <option value="neutral">æœªå–å¾—</option>
        </select>
      </div>
    </div>

    <!-- 3è¡Œç›®ã«æ‹ ç‚¹ãƒ¬ãƒ™ãƒ«ã¨ç‰¹å®šçŠ¶æ³ã‚’é…ç½® -->
    <div class="filter-row">
      <div class="filter-item">
        <label for="levelFilter" class="filter-label">æ‹ ç‚¹ãƒ¬ãƒ™ãƒ«</label>
        <select id="levelFilter" class="filter-select">
          <option value="">ã™ã¹ã¦è¡¨ç¤º</option>
          <option value="S">S</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
        </select>
      </div>

      <div class="filter-item">
        <label for="identifiedFilter" class="filter-label">ç‰¹å®šçŠ¶æ³</label>
        <select id="identifiedFilter" class="filter-select">
          <option value="">ã™ã¹ã¦è¡¨ç¤º</option>
          <option value="ç‰¹å®šæ¸ˆã¿">ç‰¹å®šæ¸ˆã¿</option>
          <option value="æœªç‰¹å®š">æœªç‰¹å®š</option>
        </select>
      </div>
    </div>
  </div>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
  <div id="loadingIndicator" class="loading-container">
    <div class="loading-spinner"></div>
    <p class="loading-text">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>

  <div class="spot-gallery" id="spotGallery"></div>

  <div class="modal-bg" id="modalBg">
    <div class="modal">
      <button class="close-btn" id="closeModal">Ã—</button>
      <h1>ğŸ“ ã‚¹ãƒãƒƒãƒˆç™»éŒ²</h1>
      <form id="spotForm">
        <label><span class="required-indicator">ã€å¿…é ˆã€‘</span>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
        <input type="file" id="image" accept="image/*" required>

        <label>ã‚¹ãƒãƒƒãƒˆå</label>
        <input type="text" id="name">

        <label for="latlng">ç·¯åº¦ãƒ»çµŒåº¦</label> <small class="help-text">ä¾‹: (35.6318549, 139.8809267)</small>
        <input type="text" id="latlng">

        <label>ä½æ‰€</label>
        <input type="text" id="address">

        <label>éƒ½é“åºœçœŒ</label>
        <select id="prefecture">
          <option value="" selected class="default-option">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="åŒ—æµ·é“">åŒ—æµ·é“</option>
          <option value="é’æ£®çœŒ">é’æ£®çœŒ</option>
          <option value="å²©æ‰‹çœŒ">å²©æ‰‹çœŒ</option>
          <option value="å®®åŸçœŒ">å®®åŸçœŒ</option>
          <option value="ç§‹ç”°çœŒ">ç§‹ç”°çœŒ</option>
          <option value="å±±å½¢çœŒ">å±±å½¢çœŒ</option>
          <option value="ç¦å³¶çœŒ">ç¦å³¶çœŒ</option>
          <option value="èŒ¨åŸçœŒ">èŒ¨åŸçœŒ</option>
          <option value="æ ƒæœ¨çœŒ">æ ƒæœ¨çœŒ</option>
          <option value="ç¾¤é¦¬çœŒ">ç¾¤é¦¬çœŒ</option>
          <option value="åŸ¼ç‰çœŒ">åŸ¼ç‰çœŒ</option>
          <option value="åƒè‘‰çœŒ">åƒè‘‰çœŒ</option>
          <option value="æ±äº¬éƒ½">æ±äº¬éƒ½</option>
          <option value="ç¥å¥ˆå·çœŒ">ç¥å¥ˆå·çœŒ</option>
          <option value="æ–°æ½ŸçœŒ">æ–°æ½ŸçœŒ</option>
          <option value="å¯Œå±±çœŒ">å¯Œå±±çœŒ</option>
          <option value="çŸ³å·çœŒ">çŸ³å·çœŒ</option>
          <option value="ç¦äº•çœŒ">ç¦äº•çœŒ</option>
          <option value="å±±æ¢¨çœŒ">å±±æ¢¨çœŒ</option>
          <option value="é•·é‡çœŒ">é•·é‡çœŒ</option>
          <option value="å²é˜œçœŒ">å²é˜œçœŒ</option>
          <option value="é™å²¡çœŒ">é™å²¡çœŒ</option>
          <option value="æ„›çŸ¥çœŒ">æ„›çŸ¥çœŒ</option>
          <option value="ä¸‰é‡çœŒ">ä¸‰é‡çœŒ</option>
          <option value="æ»‹è³€çœŒ">æ»‹è³€çœŒ</option>
          <option value="äº¬éƒ½åºœ">äº¬éƒ½åºœ</option>
          <option value="å¤§é˜ªåºœ">å¤§é˜ªåºœ</option>
          <option value="å…µåº«çœŒ">å…µåº«çœŒ</option>
          <option value="å¥ˆè‰¯çœŒ">å¥ˆè‰¯çœŒ</option>
          <option value="å’Œæ­Œå±±çœŒ">å’Œæ­Œå±±çœŒ</option>
          <option value="é³¥å–çœŒ">é³¥å–çœŒ</option>
          <option value="å³¶æ ¹çœŒ">å³¶æ ¹çœŒ</option>
          <option value="å²¡å±±çœŒ">å²¡å±±çœŒ</option>
          <option value="åºƒå³¶çœŒ">åºƒå³¶çœŒ</option>
          <option value="å±±å£çœŒ">å±±å£çœŒ</option>
          <option value="å¾³å³¶çœŒ">å¾³å³¶çœŒ</option>
          <option value="é¦™å·çœŒ">é¦™å·çœŒ</option>
          <option value="æ„›åª›çœŒ">æ„›åª›çœŒ</option>
          <option value="é«˜çŸ¥çœŒ">é«˜çŸ¥çœŒ</option>
          <option value="ç¦å²¡çœŒ">ç¦å²¡çœŒ</option>
          <option value="ä½è³€çœŒ">ä½è³€çœŒ</option>
          <option value="é•·å´çœŒ">é•·å´çœŒ</option>
          <option value="ç†Šæœ¬çœŒ">ç†Šæœ¬çœŒ</option>
          <option value="å¤§åˆ†çœŒ">å¤§åˆ†çœŒ</option>
          <option value="å®®å´çœŒ">å®®å´çœŒ</option>
          <option value="é¹¿å…å³¶çœŒ">é¹¿å…å³¶çœŒ</option>
          <option value="æ²–ç¸„çœŒ">æ²–ç¸„çœŒ</option>
        </select>

        <label><span class="required-indicator">ã€å¿…é ˆã€‘</span>ã‚®ãƒ«ãƒ‰</label>
        <select id="team" required>
          <option value="" disabled selected class="default-option">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="your guild">è‡ªã‚®ãƒ«ãƒ‰ï¼ˆgreenï¼‰</option>
          <option value="enemy">æ•µã‚®ãƒ«ãƒ‰ï¼ˆredï¼‰</option>
          <option value="neutral">æœªå–å¾—ï¼ˆwhiteï¼‰</option>
        </select>

        <div id="enemyGuildNameContainer" class="hidden">
          <label>æ•µã‚®ãƒ«ãƒ‰å</label>
          <input type="text" id="enemyGuildName">
        </div>

        <label><span class="required-indicator">ã€å¿…é ˆã€‘</span>æ‹ ç‚¹ãƒ¬ãƒ™ãƒ«</label>
        <select id="level" required>
          <option value="" disabled selected class="default-option">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="S">S</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
        </select>

        <label><span class="required-indicator">ã€å¿…é ˆã€‘</span>ç™»éŒ²è€…å</label>
        <input type="text" id="owner" required>

        <label><span class="required-indicator">ã€å¿…é ˆã€‘</span>ç‰¹å®šçŠ¶æ³</label>
        <select id="identified" required>
          <option value="æœªç‰¹å®š" selected>æœªç‰¹å®š</option>
          <option value="ç‰¹å®šæ¸ˆã¿">ç‰¹å®šæ¸ˆã¿</option>
        </select>

        <!-- â–¼â–¼â–¼ è¿½åŠ  â–¼â–¼â–¼ -->
        <label>100ã‚­ãƒ­åœå†…ã®éƒ½é“åºœçœŒ</label>
        <input type="text" id="nearbyPrefectures" placeholder="ä¾‹: æ±äº¬éƒ½,ç¥å¥ˆå·çœŒ,åŸ¼ç‰çœŒ">

        <label>Code</label>
        <input type="text" id="code" placeholder="ä¾‹: ABC123">
        <!-- â–²â–²â–² è¿½åŠ  â–²â–²â–² -->

        <button type="submit" style="margin-top: 16px;">é€ä¿¡</button>
      </form>
      <div id="result" style="margin-top: 10px; font-weight: bold;"></div>
    </div>
  </div>

  <script>
    const form = document.getElementById('spotForm');
    const teamSelect = document.getElementById('team');
    const enemyGuildNameContainer = document.getElementById('enemyGuildNameContainer');
    const resultBox = document.getElementById('result');

    const openBtn = document.getElementById('openModal');
    const closeBtn = document.getElementById('closeModal');
    const modalBg = document.getElementById('modalBg');

    openBtn.onclick = () => modalBg.style.display = 'flex';
    closeBtn.onclick = () => modalBg.style.display = 'none';

    // â˜…â˜…â˜… ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹å‡¦ç† (æ–°è¦ãƒ»ç·¨é›† å…±é€š) â˜…â˜…â˜…
    window.addEventListener('click', (event) => {
      // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ãŒãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ (.modal-bg) ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
      if (event.target.classList.contains('modal-bg')) {
         // èƒŒæ™¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ã€ãã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
         event.target.style.display = 'none';
         console.log(`ãƒ¢ãƒ¼ãƒ€ãƒ« ${event.target.id || '(IDãªã—)'} ã‚’èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã¾ã—ãŸã€‚`);
      }
    });

    teamSelect.addEventListener('change', () => {
      enemyGuildNameContainer.classList.toggle('hidden', teamSelect.value !== 'enemy');
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é€ä¿¡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      resultBox.innerText = ''; // å‰å›ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢

      // --- â–¼â–¼â–¼ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ  â–¼â–¼â–¼ ---
      let errors = [];
      const imageInput = document.getElementById('image');
      const teamSelect = document.getElementById('team');
      const levelSelect = document.getElementById('level');
      const ownerInput = document.getElementById('owner');
      const identifiedSelect = document.getElementById('identified');
      const latlngInput = document.getElementById('latlng'); // ä»»æ„ã ãŒå½¢å¼ãƒã‚§ãƒƒã‚¯ç”¨
      // â–¼â–¼â–¼ è¿½åŠ  â–¼â–¼â–¼
      const nearbyPrefecturesInput = document.getElementById('nearbyPrefectures');
      const codeInput = document.getElementById('code');
      // â–²â–²â–² è¿½åŠ  â–²â–²â–²

      // 1. ç”»åƒ (å¿…é ˆ)
      if (imageInput.files.length === 0) {
        errors.push('ãƒ»ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
      } else if (imageInput.files[0].size > 5 * 1024 * 1024) {
        errors.push('ãƒ»ç”»åƒã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚');
      }

      // 2. ã‚®ãƒ«ãƒ‰ (å¿…é ˆ)
      if (teamSelect.value === "") { // value="" ã®ã€Œé¸æŠã—ã¦ãã ã•ã„ã€ãŒé¸ã°ã‚Œã¦ã„ãªã„ã‹
        errors.push('ãƒ»ã‚®ãƒ«ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
      }

      // 3. æ‹ ç‚¹ãƒ¬ãƒ™ãƒ« (å¿…é ˆ)
      if (levelSelect.value === "") { // value="" ã®ã€Œé¸æŠã—ã¦ãã ã•ã„ã€ãŒé¸ã°ã‚Œã¦ã„ãªã„ã‹
        errors.push('ãƒ»æ‹ ç‚¹ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
      }

      // 4. ç™»éŒ²è€…å (å¿…é ˆ)
      if (ownerInput.value.trim() === '') {
        errors.push('ãƒ»ç™»éŒ²è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      }

      // 5. ç‰¹å®šçŠ¶æ³ (å¿…é ˆ) - value="" ãŒãªã„ã®ã§é¸æŠã•ã‚Œã¦ã„ã‚Œã°OK
      if (!identifiedSelect.value) {
          errors.push('ãƒ»ç‰¹å®šçŠ¶æ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); // é€šå¸¸ç™ºç”Ÿã—ãªã„ã¯ãš
      }

      // 6. ç·¯åº¦ãƒ»çµŒåº¦ (ä»»æ„ã ãŒã€å…¥åŠ›ãŒã‚ã‚Œã°å½¢å¼ãƒã‚§ãƒƒã‚¯)
      const latlngValue = latlngInput.value.trim();
      if (latlngValue !== '') { // å…¥åŠ›ãŒã‚ã‚‹å ´åˆã®ã¿ãƒã‚§ãƒƒã‚¯
          const latlngParts = latlngValue.replace(/[()\s]/g, '').split(',');
          if (latlngParts.length !== 2 || isNaN(parseFloat(latlngParts[0])) || isNaN(parseFloat(latlngParts[1]))) {
              errors.push('ãƒ»ç·¯åº¦ãƒ»çµŒåº¦ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ (ä¾‹: 35.6, 139.8)ã€‚');
          }
      }
      // --- â–²â–²â–² ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ã“ã“ã¾ã§ â–²â–²â–² ---

      // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°è¡¨ç¤ºã—ã¦é€ä¿¡ã‚’ä¸­æ­¢
      if (errors.length > 0) {
        resultBox.innerHTML = `<div style="color: #ff6b6b; text-align: left; margin: 10px 0;">
          <strong>âš ï¸ ä»¥ä¸‹ã®é …ç›®ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š</strong><br>
          ${errors.join('<br>')}
        </div>`;
        return;
      }

      // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
      const formData = new FormData();
      formData.append('imageFile', imageInput.files[0]);
      formData.append('name', document.getElementById('name').value);
      formData.append('latlng', latlngInput.value);
      formData.append('address', document.getElementById('address').value);
      formData.append('prefecture', document.getElementById('prefecture').value);
      formData.append('team', teamSelect.value);
      formData.append('enemyGuildName', document.getElementById('enemyGuildName').value);
      formData.append('level', levelSelect.value);
      formData.append('owner', ownerInput.value);
      formData.append('identified', identifiedSelect.value);
      // â–¼â–¼â–¼ è¿½åŠ  â–¼â–¼â–¼
      formData.append('nearbyPrefectures', nearbyPrefecturesInput.value);
      formData.append('code', codeInput.value);
      // â–²â–²â–² è¿½åŠ  â–²â–²â–²

      // --- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é€šéå¾Œ: é€ä¿¡å‡¦ç† ---
      resultBox.innerText = 'â³ ç™»éŒ²å‡¦ç†ä¸­...';
      resultBox.style.color = ''; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è‰²ã‚’å…ƒã«æˆ»ã™
      resultBox.style.whiteSpace = ''; // æ”¹è¡Œè¨­å®šã‚’å…ƒã«æˆ»ã™

      const image = imageInput.files[0];
      const reader = new FileReader();

      reader.onload = async function () {
        const base64Image = reader.result.split(',')[1];
        if (!base64Image) {
          resultBox.innerText = 'âŒ ã‚¨ãƒ©ãƒ¼: ç”»åƒãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
          return;
        }

        // ç·¯åº¦çµŒåº¦ã¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ¸ˆã¿ãªã®ã§ã€å†åº¦å–å¾—ã—ã¦ä½¿ã†
        const latlngValue = document.getElementById('latlng').value.trim();
        const finalLatLng = latlngValue === '' ? ['', ''] : latlngValue.replace(/[()\s]/g, '').split(',');

        // --- â–¼â–¼â–¼ ã‚¹ãƒãƒƒãƒˆåãŒç©ºãªã‚‰ã€Œã‚¹ãƒãƒƒãƒˆä¸æ˜ã€ã‚’è¨­å®š â–¼â–¼â–¼ ---
        let spotName = document.getElementById('name').value.trim();
        if (spotName === '') {
            spotName = 'ã‚¹ãƒãƒƒãƒˆä¸æ˜'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®åå‰ã‚’è¨­å®š
            console.log('ã‚¹ãƒãƒƒãƒˆåãŒæœªå…¥åŠ›ã®ãŸã‚ã€Œã‚¹ãƒãƒƒãƒˆä¸æ˜ã€ã‚’è¨­å®šã—ã¾ã—ãŸã€‚');
        }
        // --- â–²â–²â–² ã“ã“ã¾ã§è¿½åŠ  â–²â–²â–² ---

        const formData = new URLSearchParams();
        formData.append('imageFile', base64Image);
        formData.append('imageType', image.type);
        formData.append('name', spotName); // â˜… ä¿®æ­£: spotName å¤‰æ•°ã‚’ä½¿ã†
        formData.append('lat', parseFloat(finalLatLng[0] || "0").toString()); // ä»»æ„é …ç›®
        formData.append('lng', parseFloat(finalLatLng[1] || "0").toString()); // ä»»æ„é …ç›®
        formData.append('address', document.getElementById('address').value); // ä»»æ„é …ç›®
        formData.append('prefecture', document.getElementById('prefecture').value); // ä»»æ„é …ç›®
        formData.append('team', teamSelect.value); // å¿…é ˆé …ç›®
        formData.append('enemyGuildName', document.getElementById('enemyGuildName').value); // ä»»æ„é …ç›®
        formData.append('level', levelSelect.value); // å¿…é ˆé …ç›®
        formData.append('owner', ownerInput.value); // å¿…é ˆé …ç›®
        formData.append('identified', identifiedSelect.value); // å¿…é ˆé …ç›®
        formData.append('displayOrder', '999999'); // æ–°è¦ç™»éŒ²æ™‚ã¯æœ€å¤§å€¤ã‚’ä½¿ç”¨

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼šé€ä¿¡ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
        console.log("ğŸ“ æ–°è¦ç™»éŒ² - é€ä¿¡ãƒ‡ãƒ¼ã‚¿:", {
          name: spotName, // â˜… ä¿®æ­£: spotName å¤‰æ•°ã‚’ä½¿ã†
          lat: parseFloat(finalLatLng[0] || "0"),
          lng: parseFloat(finalLatLng[1] || "0"),
          address: document.getElementById('address').value,
          prefecture: document.getElementById('prefecture').value,
          team: teamSelect.value,
          enemyGuildName: document.getElementById('enemyGuildName').value,
          level: levelSelect.value,
          owner: ownerInput.value,
          identified: identifiedSelect.value,
          displayOrder: '999999' // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã«ã‚‚è¡¨ç¤ºé †ã‚’è¿½åŠ 
        });

        try {
          const response = await fetch('https://script.google.com/macros/s/AKfycbx7slBtDJzVH3PYnSHW5MIgjEvm2XJAWBVN9RO05ALNgxMnyBDGS608OuEHBGBhi_aPJw/exec', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: formData.toString() // URLSearchParamsã‚’æ˜ç¤ºçš„ã«æ–‡å­—åˆ—åŒ–
          });

          // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
          const text = await response.text();
          let result;

          try {
            result = JSON.parse(text);
          } catch (e) {
            console.error('JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
            console.error('å—ä¿¡ã—ãŸãƒ†ã‚­ã‚¹ãƒˆ:', text);
            throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ç„¡åŠ¹ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ã‘å–ã‚Šã¾ã—ãŸ: ${text}`);
          }

          if (result.result === "error") {
            throw new Error(result.message || "ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }

          // âœ… æˆåŠŸæ™‚ã®å‡¦ç†
          resultBox.innerText = 'âœ… ç™»éŒ²ã—ã¾ã—ãŸï¼è¡¨ç¤ºã‚’æ›´æ–°ã—ã¾ã™...';
          form.reset();
          
          // â˜…â˜…â˜… ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º & æ›´æ–° â˜…â˜…â˜…
          modalBg.style.display = 'none'; // æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
          const loadingIndicator = document.getElementById('loadingIndicator');
          if (loadingIndicator) loadingIndicator.style.display = 'flex'; // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
          await loadSpots(); // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿å®Ÿè¡Œ
        } catch (error) {
          console.error('ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
          resultBox.innerText = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ'}`;
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå†è©¦è¡Œã§ãã‚‹ã‚ˆã†ã«ï¼‰
        }
      };

      reader.onerror = function() {
        resultBox.innerText = 'âŒ ã‚¨ãƒ©ãƒ¼: ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
      };

      reader.readAsDataURL(image);
    });
  </script>

  <script>
    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    window.spotDataArray = [];      // è¡¨ç¤ºé †ã§ã‚½ãƒ¼ãƒˆæ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿é…åˆ—
    window.selectedFilters = {
      keyword: '',
      prefecture: '',
      team: '',
      identified: '',
      level: ''
    };

    // --- loadSpots é–¢æ•°ã®ä¿®æ­£ ---
    async function loadSpots() {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
      const loadingIndicator = document.getElementById('loadingIndicator');
      loadingIndicator.style.display = 'flex';
      
      try {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œã‚’å›é¿ã™ã‚‹ãŸã‚ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
        const timestamp = new Date().getTime();
        const sheetUrl = `https://docs.google.com/spreadsheets/d/1XWirleOXBpzKw-cvyl_FVbfoqhCiXmYCefoAFJzZMd8/gviz/tq?tqx=out:json&_=${timestamp}`;
        
        console.log('ğŸ“¥ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
        const res = await fetch(sheetUrl, { 
          cache: 'no-store'  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã—ãªã„
        });
        
        const text = await res.text();
        const json = JSON.parse(text.replace("/*O_o*/\ngoogle.visualization.Query.setResponse(", "").slice(0, -2));
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®é †åºé€šã‚Šã«è¡¨ç¤º
        const rows = json.table.rows;
        console.log(`ğŸ“Š gviz APIå¿œç­”: ${rows ? rows.length : 0} è¡Œã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸã€‚`);

        if (!rows) {
          console.error("âŒ gviz APIã‹ã‚‰è¡Œãƒ‡ãƒ¼ã‚¿(rows)ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
          // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          const gallery = document.getElementById("spotGallery");
          gallery.innerHTML = '<div class="error-message">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãçµŒã£ã¦ã‹ã‚‰ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</div>';
          return;
        }

        // æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        const validRows = [];
        const invalidRowsInfo = []; // é™¤å¤–ã•ã‚ŒãŸè¡Œã®æƒ…å ±ã‚’æ ¼ç´

        rows.forEach((row, index) => {
          let isValid = false;
          let reason = 'ä¸æ˜';

          if (row && row.c) {
            const id = row.c[0] ? row.c[0].v : null; // Aåˆ—ã®å€¤
            const name = row.c[1] ? row.c[1].v : null; // Båˆ—ã®å€¤
            const displayOrder = row.c[14] ? row.c[14].v : null; // Oåˆ—ã®å€¤

            // å…ƒã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¡ä»¶
            const hasId = id !== null && id !== '';
            const hasName = name !== null && name !== '';
            const hasDisplayOrder = displayOrder !== null && displayOrder !== ''; // ç©ºç™½ã‚‚ãƒã‚§ãƒƒã‚¯

            isValid = hasId && hasName && hasDisplayOrder;

            if (!isValid) {
              // é™¤å¤–ç†ç”±ã‚’ç‰¹å®š
              if (!hasId) reason = 'ID(Aåˆ—)ãŒç©ºã¾ãŸã¯null';
              else if (!hasName) reason = 'ã‚¹ãƒãƒƒãƒˆå(Båˆ—)ãŒç©ºã¾ãŸã¯null';
              else if (!hasDisplayOrder) reason = 'è¡¨ç¤ºé †(Oåˆ—)ãŒç©ºã¾ãŸã¯null';
              else reason = 'ãã®ä»–ã®ç†ç”±ï¼ˆãƒ‡ãƒ¼ã‚¿å½¢å¼ãªã©ï¼‰';

              // é™¤å¤–æƒ…å ±ã‚’è¨˜éŒ²
              invalidRowsInfo.push({
                sheetRow: index + 2, // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¸Šã®è¡Œç•ªå· (ãƒ˜ãƒƒãƒ€é™¤ã)
                idValue: id,
                nameValue: name,
                displayOrderValue: displayOrder,
                exclusionReason: reason
              });
            }
          } else {
            // row ã¾ãŸã¯ row.c ãŒ null ã®å ´åˆ
            reason = 'è¡Œãƒ‡ãƒ¼ã‚¿è‡ªä½“ãŒnullã¾ãŸã¯ä¸æ­£';
            invalidRowsInfo.push({
              sheetRow: index + 2,
              idValue: 'N/A',
              nameValue: 'N/A',
              displayOrderValue: 'N/A',
              exclusionReason: reason
            });
          }

          if (isValid) {
            validRows.push(row); // æœ‰åŠ¹ãªè¡Œã®ã¿è¿½åŠ 
          }
        });

        // é™¤å¤–ã•ã‚ŒãŸè¡ŒãŒã‚ã‚Œã°ãã®æƒ…å ±ã‚’è¡¨ç¤º
        if (invalidRowsInfo.length > 0) {
          console.warn(`âš ï¸ ${invalidRowsInfo.length} ä»¶ã®è¡ŒãŒãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã§é™¤å¤–ã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã¯ä»¥ä¸‹ã®é€šã‚Š:`);
          console.table(invalidRowsInfo); // ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§è¦‹ã‚„ã™ãè¡¨ç¤º
        } else if (rows.length > 0) {
          console.log("âœ… ã™ã¹ã¦ã®è¡ŒãŒãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¡ä»¶ã‚’æº€ãŸã—ã¾ã—ãŸã€‚");
        }

        console.log(`ğŸ”¢ æœ€çµ‚çš„ãªæœ‰åŠ¹ã‚¹ãƒãƒƒãƒˆæ•° (è¡¨ç¤ºå¯¾è±¡): ${validRows.length} ä»¶`);
        
        // â˜…â˜…â˜… å¸¸ã«è¡¨ç¤ºé † (Oåˆ—) ã§ã‚½ãƒ¼ãƒˆ â˜…â˜…â˜…
        validRows.sort((a, b) => {
          const orderA = (a.c && a.c[14] && !isNaN(parseInt(a.c[14].v))) ? parseInt(a.c[14].v) : Number.MAX_SAFE_INTEGER;
          const orderB = (b.c && b.c[14] && !isNaN(parseInt(b.c[14].v))) ? parseInt(b.c[14].v) : Number.MAX_SAFE_INTEGER;
          return orderA - orderB;
        });
        console.log("ğŸ”„ åˆæœŸã‚½ãƒ¼ãƒˆ: è¡¨ç¤ºé † (Oåˆ—) ã§ã‚½ãƒ¼ãƒˆã—ã¾ã—ãŸã€‚");

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é…åˆ—ã¨ã—ã¦ã‚¹ãƒãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒï¼ˆè¡¨ç¤ºé †ã‚½ãƒ¼ãƒˆæ¸ˆã¿ï¼‰
        window.spotDataArray = validRows.map(row => { // validRows ã‚’å¤‰æ›ã—ã¦ spotDataArray ã‚’ä½œæˆ
          const id = row.c[0]?.v || "";
          const name = row.c[1]?.v || "";
          const lat = parseFloat(row.c[2]?.v || "0");
          const lng = parseFloat(row.c[3]?.v || "0");
          const address = row.c[4]?.v || "";
          const prefecture = row.c[5]?.v || "";
          const team = row.c[6]?.v || "neutral";
          const enemyGuildName = row.c[7]?.v || "";
          const level = row.c[8]?.v || "";
          const owner = row.c[9]?.v || "";
          const identified = row.c[10]?.v || "æœªç‰¹å®š";
          const imageUrl = row.c[11]?.v || "";
          const base64Data = row.c[13]?.v || ""; // å¤‰æ•°åã‚’ base64Data ã«å¤‰æ›´
          const displayOrder = parseInt(row.c[14]?.v) || Number.MAX_SAFE_INTEGER;
          
          // â–¼â–¼â–¼ æ–°ã—ã„é …ç›®ã‚’ã“ã“ã§ã‚‚å–å¾—ã—ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å«ã‚ã‚‹ â–¼â–¼â–¼
          const nearbyPrefectures = row.c[15]?.v || ""; // Påˆ—
          const code = row.c[16]?.v || "";             // Qåˆ—
          // â–²â–²â–² â–²â–²â–²

          return {
              id, name, lat, lng, address, prefecture, team, enemyGuildName,
              level, owner, identified, imageUrl, imageBase64: base64Data, // imageBase64 ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«æ ¼ç´
              displayOrder,
              nearbyPrefectures, // è¿½åŠ 
              code               // è¿½åŠ 
          };
      });

        // åˆæœŸè¡¨ç¤ºã®ãŸã‚ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        applyCombinedFilters();
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        const gallery = document.getElementById("spotGallery");
        gallery.innerHTML = `<div class="error-message">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}<br>ã—ã°ã‚‰ãçµŒã£ã¦ã‹ã‚‰ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</div>`;
      } finally {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’éè¡¨ç¤º
        loadingIndicator.style.display = 'none';
      }
    }

    // --- applyCombinedFilters é–¢æ•°ã®ä¿®æ­£ ---
    function applyCombinedFilters() {
      const gallery = document.getElementById("spotGallery");
      gallery.innerHTML = "";

      // const { keyword, prefecture, team, identified, level } = window.selectedFilters; // window.selectedFiltersã‹ã‚‰ç›´æ¥å‚ç…§ã™ã‚‹ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ

      if (!window.spotDataArray || !Array.isArray(window.spotDataArray)) {
        console.error("ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ã‚¨ãƒ©ãƒ¼: window.spotDataArray ãŒä¸æ­£ã§ã™ã€‚");
        return;
      }

      // 1. çµã‚Šè¾¼ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨ (è¡¨ç¤ºé †ã‚½ãƒ¼ãƒˆæ¸ˆã¿é…åˆ—ã«å¯¾ã—ã¦)
      const filtered = window.spotDataArray.filter(spot => {
        let match = true;

        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (window.selectedFilters.keyword && window.selectedFilters.keyword.trim() !== '') {
          const searchTerm = window.selectedFilters.keyword.trim().toLowerCase();
          // spot ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å°æ–‡å­—ã«ã—ã¦æ¤œç´¢
          const name = (spot.name || "").toLowerCase();
          const address = (spot.address || "").toLowerCase();
          const spotPrefecture = (spot.prefecture || "").toLowerCase(); // å¤‰æ•°åã‚’ spot.prefecture ã¨åŒºåˆ¥
          const enemyGuildName = (spot.enemyGuildName || "").toLowerCase();
          const owner = (spot.owner || "").toLowerCase();
          const code = (String(spot.code || "")).toLowerCase(); // <<< ä¿®æ­£ç‚¹: String() ã§æ˜ç¤ºçš„ã«æ–‡å­—åˆ—ã«å¤‰æ›
          
          match = match && (
            name.includes(searchTerm) || 
            address.includes(searchTerm) ||
            spotPrefecture.includes(searchTerm) || // ä¿®æ­£: spot.prefecture ã®å†…å®¹ã‚’ä½¿ç”¨
            enemyGuildName.includes(searchTerm) ||
            owner.includes(searchTerm) ||
            code.includes(searchTerm) // <<< è¿½åŠ 
          );
        }
        
        // éƒ½é“åºœçœŒãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (window.selectedFilters.prefecture) {
          match = match && spot.prefecture === window.selectedFilters.prefecture;
        }

        // ã‚®ãƒ«ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (window.selectedFilters.team) {
          match = match && spot.team === window.selectedFilters.team;
        }
        
        // ç‰¹å®šçŠ¶æ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (window.selectedFilters.identified) {
          match = match && spot.identified === window.selectedFilters.identified;
        }

        // ãƒ¬ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (window.selectedFilters.level) {
          match = match && spot.level === window.selectedFilters.level;
        }

        return match;
      });

      console.log('çµã‚Šè¾¼ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨å¾Œã®ä»¶æ•°:', filtered.length);

      // 2. ã‚«ãƒ¼ãƒ‰ã‚’æç”»
      let cardCount = 0;
      filtered.forEach((spot, i) => { // filtered ã®å„è¦ç´  spot ã¯æ—¢ã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
          cardCount++;

          // spot ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ç›´æ¥ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ãƒˆåã‚’å¤‰æ›´ï¼‰
          const {
              id, name, lat, lng, address, 
              prefecture: spotPref, // prefecture ã®ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ãƒˆåã‚’ spotPref ã«å¤‰æ›´
              team: spotTeam, // team ã®ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ãƒˆåã‚’ spotTeam ã«å¤‰æ›´
              level: spotLevel, // level ã®ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ãƒˆåã‚’ spotLevel ã«å¤‰æ›´
              owner: spotOwner, // owner ã®ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ãƒˆåã‚’ spotOwner ã«å¤‰æ›´
              identified: spotIdentified, // identified ã®ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ãƒˆåã‚’ spotIdentified ã«å¤‰æ›´
              imageUrl, imageBase64, // imageBase64 ã¯ã“ã®åå‰ã§ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ãƒˆ
              displayOrder,
              nearbyPrefectures, // è¿½åŠ 
              code               // è¿½åŠ 
          } = spot;

          const originalIndexInFull = window.spotDataArray.findIndex(originalSpot => originalSpot.id === id);
          const rowIndex = originalIndexInFull !== -1 ? originalIndexInFull + 2 : i + 2; // ã‚·ãƒ¼ãƒˆä¸Šã®è¡Œç•ªå·ã«è¿‘ã„å€¤

          const dataForCard = { // setupModalEvent ã«æ¸¡ã™ãƒ‡ãƒ¼ã‚¿
              id, rowIndex, name, lat, lng, 
              team: spotTeam, // ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã—ãŸå¤‰æ•°ã‚’ä½¿ç”¨
              level: spotLevel, // ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã—ãŸå¤‰æ•°ã‚’ä½¿ç”¨
              imageUrl, address, 
              prefecture: spotPref, // ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã—ãŸå¤‰æ•°ã‚’ä½¿ç”¨
              enemyGuildName: spot.enemyGuildName, // spotã‹ã‚‰ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã‚‚å¯
              owner: spotOwner, // ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã—ãŸå¤‰æ•°ã‚’ä½¿ç”¨
              imageBase64: imageBase64, // â˜…â˜…â˜… ã“ã“ã‚’ä¿®æ­£: imageBase64 ã‚’ä½¿ç”¨ â˜…â˜…â˜…
              identified: spotIdentified, // ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã—ãŸå¤‰æ•°ã‚’ä½¿ç”¨
              displayOrder,
              nearbyPrefectures, // è¿½åŠ 
              code               // è¿½åŠ 
          };

          const card = document.createElement("div");
          card.className = "spot-card";
          card.setAttribute('data-id', id);
          card.setAttribute('data-row-index', rowIndex); // å‰Šé™¤ã‚„ç·¨é›†ã®ãŸã‚ã«è¡Œç•ªå·ã‚‚ä¿æŒ

          const img = document.createElement("img");
          img.alt = name;
          img.setAttribute('referrerpolicy', 'no-referrer');

          // ç”»åƒã‚½ãƒ¼ã‚¹ã®è¨­å®š (Base64å„ªå…ˆ)
          if (imageBase64 && imageBase64.length > 100) { // imageBase64 ã‚’ä½¿ç”¨
            img.src = `data:image/jpeg;base64,${imageBase64}`;
          } else if (imageUrl) { // ãªã‘ã‚Œã°Driveã®URL
            img.src = imageUrl;
            img.onerror = function () { // ã‚¨ãƒ©ãƒ¼å‡¦ç†
              img.src = ""; // ç”»åƒURLãŒç„¡åŠ¹ãªã‚‰éè¡¨ç¤º
              img.alt = "ç”»åƒãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“";
            };
          } else { // ã©ã¡ã‚‰ã‚‚ãªã‘ã‚Œã°
            img.src = "";
            img.alt = "ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“";
          }

          // ç”»åƒã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤åŠ¹æœã‚’è¿½åŠ 
          if (spotTeam === "your guild" || spotTeam === "enemy") { // spotTeam ã‚’ä½¿ç”¨
            const overlay = document.createElement("div");
            overlay.className = "card-overlay";
            if (spotTeam === "your guild") overlay.classList.add("overlay-green");
            else if (spotTeam === "enemy") overlay.classList.add("overlay-red");
            card.appendChild(overlay);
          }

          card.appendChild(img); // ç”»åƒã‚’ã‚«ãƒ¼ãƒ‰ã«è¿½åŠ 

          // å·¦ä¸Š â†’ level
          if (spotLevel) { // spotLevel ã‚’ä½¿ç”¨
            const levelBadge = document.createElement("div");
            let levelClass = "";
            switch(spotLevel) {
              case "S": levelClass = "s-rank"; break;
              case "A": levelClass = "a-rank"; break;
              case "B": levelClass = "b-rank"; break;
              case "C": levelClass = "c-rank"; break;
              case "D": levelClass = "d-rank"; break;
              default: levelClass = "";
            }
            levelBadge.className = `badge level ${levelClass}`;
            levelBadge.textContent = spotLevel;
            levelBadge.style.left = "6px";
            levelBadge.style.top = "6px";
            card.appendChild(levelBadge);
          }

          // å³ä¸Š â†’ éƒ½é“åºœçœŒ
          if (spotPref) { // spotPref ã‚’ä½¿ç”¨
            const prefTag = document.createElement("div");
            prefTag.className = "pref-tag";
            prefTag.textContent = spotPref;
            card.appendChild(prefTag);
          }

          // å·¦ä¸‹ â†’ ç‰¹å®šçŠ¶æ³
          const identifiedBadge = document.createElement("div");
          identifiedBadge.className = `badge ${spotIdentified === "ç‰¹å®šæ¸ˆã¿" ? "blue" : "gray"}`; // spotIdentified ã‚’ä½¿ç”¨
          identifiedBadge.textContent = spotIdentified === "ç‰¹å®šæ¸ˆã¿" ? "ç‰¹å®š" : "æœªç‰¹";
          identifiedBadge.style.bottom = "6px";
          identifiedBadge.style.left = "6px";
          identifiedBadge.style.top = "auto";
          card.appendChild(identifiedBadge);

          // å³ä¸‹ â†’ ã‚®ãƒ«ãƒ‰(team)
          if (spotTeam === "your guild" || spotTeam === "enemy") { // spotTeam ã‚’ä½¿ç”¨
            const guildBadge = document.createElement("div");
            guildBadge.className = `badge ${spotTeam === "your guild" ? "green" : "red"}`;
            let teamText = (spotTeam === "your guild") ? "è‡ªè»" : "æ•µé™£";
            guildBadge.textContent = teamText;
            guildBadge.style.bottom = "6px";
            guildBadge.style.right = "6px";
            guildBadge.style.top = "auto";
            guildBadge.style.left = "auto";
            card.appendChild(guildBadge);
          }

          gallery.appendChild(card); // â˜…â˜…â˜… ã“ã‚ŒãŒé‡è¦ï¼ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã«ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ  â˜…â˜…â˜…
          setupModalEvent(card, dataForCard); // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºç”¨ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      });

      console.log("ğŸ¨ æç”»å®Œäº†ã€‚ ã‚«ãƒ¼ãƒ‰æ•°:", cardCount);
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    function setupModalEvent(card, spotData) {
      card.addEventListener('click', () => {
        const modal = document.getElementById('spotModal');
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
        document.getElementById('modal-image').src = spotData.imageBase64 
          ? `data:image/jpeg;base64,${spotData.imageBase64}` 
          : (spotData.imageUrl || '');
        
        document.getElementById('modalNameInput').value = spotData.name || '';
        document.getElementById('modalLatLngInput').value = `(${spotData.lat}, ${spotData.lng})`;
        document.getElementById('modalAddressInput').value = spotData.address || '';
        document.getElementById('modalPrefectureInput').value = spotData.prefecture || '';
        document.getElementById('modalTeamInput').value = spotData.team || 'neutral';
        document.getElementById('modalEnemyGuildInput').value = spotData.enemyGuildName || '';
        document.getElementById('modalLevelInput').value = spotData.level || '';
        document.getElementById('modalOwnerInput').value = spotData.owner || '';
        document.getElementById('modalIdentifiedInput').value = spotData.identified || 'æœªç‰¹å®š';
        
        // â–¼â–¼â–¼ è¿½åŠ  â–¼â–¼â–¼
        document.getElementById('modalNearbyPrefecturesInput').value = spotData.nearbyPrefectures || '';
        document.getElementById('modalCodeInput').value = spotData.code || '';
        // â–²â–²â–² è¿½åŠ  â–²â–²â–²
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’å±æ€§ã¨ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ä¿å­˜
        modal.dataset.spotData = JSON.stringify(spotData);
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        modal.style.display = 'flex';
      });
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    document.getElementById('keywordFilter').addEventListener('input', (e) => {
      window.selectedFilters.keyword = e.target.value;
      applyCombinedFilters();
    });

    document.getElementById('prefectureFilter').addEventListener('change', (e) => {
      window.selectedFilters.prefecture = e.target.value;
      applyCombinedFilters();
    });

    document.getElementById('teamFilter').addEventListener('change', (e) => {
      window.selectedFilters.team = e.target.value;
      applyCombinedFilters();
    });

    document.getElementById('identifiedFilter').addEventListener('change', (e) => {
      window.selectedFilters.identified = e.target.value;
      applyCombinedFilters();
    });

    document.getElementById('levelFilter').addEventListener('change', (e) => {
      window.selectedFilters.level = e.target.value;
      applyCombinedFilters();
    });

    // --- åˆæœŸè¡¨ç¤ºå‡¦ç† ---
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        await loadSpots();
        console.log("ğŸ’¾ åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: æœ‰åŠ¹ãªã‚¹ãƒãƒƒãƒˆæ•° =", window.spotDataArray?.length || 0);
        applyCombinedFilters();
      } catch (error) {
        console.error("åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
      }
    });
  </script>

  <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->
  <div id="spotModal" class="modal-bg">
    <div class="modal-view">
      <span class="modalCloseButton">&times;</span>
      <img id="modal-image" class="modal-image" alt="Spot Image" />
      <div class="modal-details">
        <p><strong>ã‚¹ãƒãƒƒãƒˆå:</strong> <input id="modalNameInput" type="text" class="modal-input" placeholder="ã‚¹ãƒãƒƒãƒˆå" /></p>
        <p><strong>ç·¯åº¦ãƒ»çµŒåº¦:</strong> <input id="modalLatLngInput" type="text" class="modal-input" placeholder="ä¾‹: (33.6219287, 130.4381177)" /></p>
        <p><strong>ä½æ‰€:</strong> <input id="modalAddressInput" type="text" class="modal-input" placeholder="ä½æ‰€" /></p>
        <p><strong>éƒ½é“åºœçœŒ:</strong> <select id="modalPrefectureInput" class="modal-input">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="åŒ—æµ·é“">åŒ—æµ·é“</option>
          <option value="é’æ£®çœŒ">é’æ£®çœŒ</option>
          <option value="å²©æ‰‹çœŒ">å²©æ‰‹çœŒ</option>
          <option value="å®®åŸçœŒ">å®®åŸçœŒ</option>
          <option value="ç§‹ç”°çœŒ">ç§‹ç”°çœŒ</option>
          <option value="å±±å½¢çœŒ">å±±å½¢çœŒ</option>
          <option value="ç¦å³¶çœŒ">ç¦å³¶çœŒ</option>
          <option value="èŒ¨åŸçœŒ">èŒ¨åŸçœŒ</option>
          <option value="æ ƒæœ¨çœŒ">æ ƒæœ¨çœŒ</option>
          <option value="ç¾¤é¦¬çœŒ">ç¾¤é¦¬çœŒ</option>
          <option value="åŸ¼ç‰çœŒ">åŸ¼ç‰çœŒ</option>
          <option value="åƒè‘‰çœŒ">åƒè‘‰çœŒ</option>
          <option value="æ±äº¬éƒ½">æ±äº¬éƒ½</option>
          <option value="ç¥å¥ˆå·çœŒ">ç¥å¥ˆå·çœŒ</option>
          <option value="æ–°æ½ŸçœŒ">æ–°æ½ŸçœŒ</option>
          <option value="å¯Œå±±çœŒ">å¯Œå±±çœŒ</option>
          <option value="çŸ³å·çœŒ">çŸ³å·çœŒ</option>
          <option value="ç¦äº•çœŒ">ç¦äº•çœŒ</option>
          <option value="å±±æ¢¨çœŒ">å±±æ¢¨çœŒ</option>
          <option value="é•·é‡çœŒ">é•·é‡çœŒ</option>
          <option value="å²é˜œçœŒ">å²é˜œçœŒ</option>
          <option value="é™å²¡çœŒ">é™å²¡çœŒ</option>
          <option value="æ„›çŸ¥çœŒ">æ„›çŸ¥çœŒ</option>
          <option value="ä¸‰é‡çœŒ">ä¸‰é‡çœŒ</option>
          <option value="æ»‹è³€çœŒ">æ»‹è³€çœŒ</option>
          <option value="äº¬éƒ½åºœ">äº¬éƒ½åºœ</option>
          <option value="å¤§é˜ªåºœ">å¤§é˜ªåºœ</option>
          <option value="å…µåº«çœŒ">å…µåº«çœŒ</option>
          <option value="å¥ˆè‰¯çœŒ">å¥ˆè‰¯çœŒ</option>
          <option value="å’Œæ­Œå±±çœŒ">å’Œæ­Œå±±çœŒ</option>
          <option value="é³¥å–çœŒ">é³¥å–çœŒ</option>
          <option value="å³¶æ ¹çœŒ">å³¶æ ¹çœŒ</option>
          <option value="å²¡å±±çœŒ">å²¡å±±çœŒ</option>
          <option value="åºƒå³¶çœŒ">åºƒå³¶çœŒ</option>
          <option value="å±±å£çœŒ">å±±å£çœŒ</option>
          <option value="å¾³å³¶çœŒ">å¾³å³¶çœŒ</option>
          <option value="é¦™å·çœŒ">é¦™å·çœŒ</option>
          <option value="æ„›åª›çœŒ">æ„›åª›çœŒ</option>
          <option value="é«˜çŸ¥çœŒ">é«˜çŸ¥çœŒ</option>
          <option value="ç¦å²¡çœŒ">ç¦å²¡çœŒ</option>
          <option value="ä½è³€çœŒ">ä½è³€çœŒ</option>
          <option value="é•·å´çœŒ">é•·å´çœŒ</option>
          <option value="ç†Šæœ¬çœŒ">ç†Šæœ¬çœŒ</option>
          <option value="å¤§åˆ†çœŒ">å¤§åˆ†çœŒ</option>
          <option value="å®®å´çœŒ">å®®å´çœŒ</option>
          <option value="é¹¿å…å³¶çœŒ">é¹¿å…å³¶çœŒ</option>
          <option value="æ²–ç¸„çœŒ">æ²–ç¸„çœŒ</option>
        </select></p>
        <p><strong>ã‚®ãƒ«ãƒ‰ç¨®åˆ¥:</strong> <select id="modalTeamInput" class="modal-input modal-select-small">
          <option value="neutral" class="default-option">æœªå–å¾—ï¼ˆwhiteï¼‰</option>
          <option value="your guild">è‡ªã‚®ãƒ«ãƒ‰ï¼ˆgreenï¼‰</option>
          <option value="enemy">æ•µã‚®ãƒ«ãƒ‰ï¼ˆredï¼‰</option>
        </select></p>
        <p><strong>æ•µã‚®ãƒ«ãƒ‰å:</strong> <input id="modalEnemyGuildInput" type="text" class="modal-input" placeholder="æ•µã‚®ãƒ«ãƒ‰å" /></p>
        <p><strong>æ‹ ç‚¹ãƒ¬ãƒ™ãƒ«:</strong> <select id="modalLevelInput" class="modal-input modal-select-small">
          <option value="" disabled selected class="default-option">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="S">S</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
        </select></p>
        <p><strong>ç™»éŒ²è€…:</strong> <input id="modalOwnerInput" type="text" class="modal-input" placeholder="ç™»éŒ²è€…å" /></p>
        <p><strong>ç‰¹å®šçŠ¶æ³:</strong> <select id="modalIdentifiedInput" class="modal-input modal-select-small">
          <option value="æœªç‰¹å®š">æœªç‰¹å®š</option>
          <option value="ç‰¹å®šæ¸ˆã¿">ç‰¹å®šæ¸ˆã¿</option>
        </select></p>

        <p><strong>100ã‚­ãƒ­åœå†…ã®éƒ½é“åºœçœŒ:</strong> <input id="modalNearbyPrefecturesInput" type="text" class="modal-input" placeholder="ä¾‹: æ±äº¬éƒ½, ç¥å¥ˆå·çœŒ" /></p>
        <p><strong>Code:</strong> <input id="modalCodeInput" type="text" class="modal-input" placeholder="ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" /></p>
      </div>
      <div class="modal-buttons">
        <button id="saveSpotButton" class="save-button">ä¿å­˜</button>
        <button id="deleteSpotButton" class="delete-button">å‰Šé™¤</button>
      </div>
    </div>
  </div>

  <script>
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®å‡¦ç†
    document.querySelectorAll(".modalCloseButton").forEach(button => {
      button.addEventListener("click", () => {
        const modal = button.closest(".modal-bg");
        modal.style.display = "none";
      });
    });
  </script>
<script>
  // ä¿å­˜ã¨å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
  document.addEventListener('DOMContentLoaded', () => {
    // ä¿å­˜ãƒœã‚¿ãƒ³ã®å‡¦ç†
    document.getElementById('saveSpotButton').addEventListener('click', async () => {
      try {
        const modal = document.getElementById('spotModal');
        const spotData = JSON.parse(modal.dataset.spotData || '{}');
        
        // const identifiedSelect = document.getElementById('modalIdentifiedInput'); // æ—§ã‚³ãƒ¼ãƒ‰
        // (identifiedSelectã®ãƒ­ã‚°ã¯å¤‰æ›´ãªã—) // æ—§ã‚³ãƒ¼ãƒ‰ã«é–¢é€£ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆ
        
        const name = document.getElementById('modalNameInput').value;
        const latLngInput = document.getElementById('modalLatLngInput').value;
        const latLng = latLngInput.replace(/[()]/g, '').split(',').map(s => s.trim());
        const lat = parseFloat(latLng[0]);
        const lng = parseFloat(latLng[1]);
        const address = document.getElementById('modalAddressInput').value;
        const prefecture = document.getElementById('modalPrefectureInput').value;
        const team = document.getElementById('modalTeamInput').value;
        const enemyGuildName = document.getElementById('modalEnemyGuildInput').value;
        const level = document.getElementById('modalLevelInput').value;
        const owner = document.getElementById('modalOwnerInput').value;
        
        // â–¼â–¼â–¼ å€¤å–å¾—ã¨ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®ç¢ºèª â–¼â–¼â–¼
        const nearbyPrefecturesElement = document.getElementById('modalNearbyPrefecturesInput');
        const codeElement = document.getElementById('modalCodeInput');

        const nearbyPrefectures = nearbyPrefecturesElement ? nearbyPrefecturesElement.value : ''; // .value ã‚’ç¢ºèªã€è¦ç´ å­˜åœ¨ãƒã‚§ãƒƒã‚¯è¿½åŠ 
        const code = codeElement ? codeElement.value : '';                         // .value ã‚’ç¢ºèªã€è¦ç´ å­˜åœ¨ãƒã‚§ãƒƒã‚¯è¿½åŠ 

        console.log('Debug: nearbyPrefecturesElement is:', nearbyPrefecturesElement); 
        console.log('Debug: nearbyPrefectures value is:', nearbyPrefectures, '(type:', typeof nearbyPrefectures, ')');
        console.log('Debug: codeElement is:', codeElement);
        console.log('Debug: code value is:', code, '(type:', typeof code, ')');
        // â–²â–²â–² å€¤å–å¾—ã¨ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®ç¢ºèª â–²â–²â–²
        
        let identified = document.getElementById('modalIdentifiedInput').value; // identified ã‚‚åŒæ§˜ã« .value ã§å–å¾—
        
        // identifiedã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç† (ã‚‚ã—selectè¦ç´ ãŒç©ºã®å¯èƒ½æ€§ãŒã‚ã‚‹å ´åˆãªã©ã€å¿…è¦ã«å¿œã˜ã¦æ®‹ã™)
        if (!identified || identified === '') {
          identified = spotData.identified || 'æœªç‰¹å®š'; // spotDataã‹ã‚‰ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          console.log("âš ï¸ identifiedãŒç©ºã®ãŸã‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é©ç”¨:", identified);
        }
        
        // (å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
        if (!name) {
          alert('ã‚¹ãƒãƒƒãƒˆåã¯å¿…é ˆé …ç›®ã§ã™');
          return;
        }
        if (isNaN(lat) || isNaN(lng)) {
          alert('ç·¯åº¦ãƒ»çµŒåº¦ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
          return;
        }
  
        const formData = new URLSearchParams();
        formData.append('id', spotData.id);
        formData.append('rowIndex', spotData.rowIndex);
        formData.append('name', name);
        formData.append('lat', lat);
        formData.append('lng', lng);
        formData.append('address', address);
        formData.append('prefecture', prefecture);
        formData.append('team', team);
        formData.append('enemyGuildName', enemyGuildName);
        formData.append('level', level);
        formData.append('owner', owner);
        formData.append('identified', identified);
        formData.append('displayOrder', spotData.displayOrder);

        // 4. formData ã«è¿½åŠ ã™ã‚‹å¤‰æ•°ã®å€¤ã‚’ç¢ºèª
        formData.append('nearbyPrefectures', nearbyPrefectures); 
        formData.append('code', code);                         
  
        console.log('ğŸ“ æ›´æ–° - é€ä¿¡ã•ã‚Œã‚‹formDataã®å…¨å†…å®¹:');
        for (const pair of formData.entries()) {
          console.log(`  ${pair[0]}: ${pair[1]}`);
        }

        // (try...catch...finally ãƒ–ãƒ­ãƒƒã‚¯å†…ã® fetch å‡¦ç†ã¯å‰å›ã®ææ¡ˆã®ã¾ã¾)
        try {
          const apiEndpoint = 'https://script.google.com/macros/s/AKfycbx7slBtDJzVH3PYnSHW5MIgjEvm2XJAWBVN9RO05ALNgxMnyBDGS608OuEHBGBhi_aPJw/exec'; // â˜…ã”è‡ªèº«ã®GAS URLã«è¦å¤‰æ›´
          const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
          const fetchOptions = {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: formData.toString(),
            mode: 'no-cors' 
          };
          
          console.log('ğŸŒ ã‚µãƒ¼ãƒãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ - ãƒ¢ãƒ¼ãƒ‰:', fetchOptions.mode);
          
          let alertMessage = null;
          const currentModal = document.getElementById('spotModal'); 

          try {
            await fetch(apiEndpoint, fetchOptions);
            alertMessage = 'âœ… æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå´ã§å‡¦ç†ã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚';

          } catch (fetchError) {
            console.error('ğŸ” ãƒ•ã‚§ãƒƒãƒã‚¨ãƒ©ãƒ¼:', fetchError);
            alertMessage = `âŒ ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ã‚¨ãƒ©ãƒ¼: ${fetchError.message || 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãªã©ã‚’ç¢ºèªã—ã¦ãã ã•ã„'}`;
          } finally {
            if (alertMessage) alert(alertMessage);
            currentModal.style.display = 'none'; 

            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) loadingIndicator.style.display = 'flex';
            await loadSpots();
          }
        } catch (error) {
          console.error('ğŸ” ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
          alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'}`);
        }
      } catch (error) {
        console.error('æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'}`);
      }
    });
    // (å‰Šé™¤ãƒœã‚¿ãƒ³ã®å‡¦ç†ã¯çœç•¥)
  });
</script>
</body>
</html>
