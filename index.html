<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>スポット登録フォーム（モーダル版）</title>
  <link rel="stylesheet" href="spot-style.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2A3A38">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="スポット管理">
  <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
  <style>
    /* キーワード検索ボックス用のスタイル */
    .filter-input {
      width: 90%;
      max-width: 800px;
      padding: 10px 14px;
      font-size: 16px;
      border: 1px solid #2A4A46;
      border-radius: 8px;
      background: #3A5A56;
      color: #ffffff;
      margin: 10px auto;
      display: block;
    }
    
    .filter-input::placeholder {
      color: #aaa;
    }
    
    /* カードオーバーレイのベーススタイル */
    .card-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      pointer-events: none; /* クリックイベントを下層に通過させる */
      border-radius: 14px; /* カードと同じ角丸に */
    }

    /* 自軍のオーバーレイ - より濃い緑色 */
    .overlay-green {
      background-color: rgba(0, 70, 0, 0.65); /* より濃い緑色 */
      box-shadow: inset 0 0 0 3px rgba(46, 204, 113, 0.9); /* 内側の枠線 */
    }

    /* 敵軍のオーバーレイ - より濃い赤色 */
    .overlay-red {
      background-color: rgba(100, 0, 0, 0.65); /* より濃い赤色 */
      box-shadow: inset 0 0 0 3px rgba(231, 76, 60, 0.9); /* 内側の枠線 */
    }

    /* オーバーレイがある場合、バッジのz-indexを上げる */
    .badge {
      z-index: 3; /* オーバーレイよりも前面に */
    }

    .pref-tag {
      z-index: 3; /* オーバーレイよりも前面に */
    }
    
    /* レベルバッジの共通スタイル - 深緑の黒背景に変更 */
    .badge.level {
      background-color: rgba(22, 33, 30, 0.85); /* 画像の深緑っぽい黒色 */
      color: white; /* デフォルト文字色 */
      border: 1px solid rgba(255, 255, 255, 0.2); /* 微かな境界線 */
    }
    
    /* レベル別の文字色 */
    .badge.level.s-rank { color: #FF5252; } /* S - 赤色 */
    .badge.level.a-rank { color: #BB86FC; } /* A - 紫色 */
    .badge.level.b-rank { color: #3D5AFE; } /* B - 青色 */
    .badge.level.c-rank { color: #00E5B9; } /* C - ミント色 */
    .badge.level.d-rank { color: #E0E0E0; } /* D - 白/グレー色 */
    
    /* エラーメッセージ用スタイル */
    .error-message {
      color: #ffdddd; /* やや明るい赤文字 */
      text-align: center;
      padding: 24px 16px;
      font-size: 1em;
    }
    
    /* 新規登録モーダル: 必須項目インジケーター */
    .modal label .required-indicator {
      color: #e74c3c; /* やや濃い赤色 */
      font-weight: bold; /* 太字にする */
      margin-right: 8px; /* 「【必須】」とラベルテキストの間に少し隙間を空ける */
    }
  </style>
  <!-- タブナビゲーション用のスタイル -->
  <style>
    /* ページ本体がタブに隠れないように下部に余白を作る */
    body {
      /* 他の body スタイルがあれば維持 */
      padding-bottom: 60px; /* タブの高さ分+α の余白を確保 */
    }

    .bottom-nav {
      position: fixed; /* 画面下部に固定 */
      bottom: 0;
      left: 0;
      width: 100%;
      height: 50px; /* タブの高さを指定 */
      background-color: #2A3A38; /* 背景色 (他の要素と合わせる) */
      border-top: 1px solid rgba(255, 255, 255, 0.1); /* 上境界線 */
      display: flex; /* タブを横並びに */
      justify-content: space-around; /* タブ間のスペースを均等に */
      align-items: center; /* 上下中央揃え */
      box-shadow: 0 -2px 5px rgba(0,0,0,0.2); /* 上向きの影 */
      z-index: 1100; /* 他の要素より手前に */
    }

    .nav-item {
      display: flex;
      flex-direction: column; /* テキスト (やアイコン) を縦に積む場合 */
      align-items: center; /* 中央揃え */
      justify-content: center; /* 中央揃え */
      flex-grow: 1; /* 各タブが均等に幅を取る */
      height: 100%;
      color: #aaa; /* 通常時のテキスト色 */
      text-decoration: none; /* リンクの下線を消す */
      text-align: center;
      padding: 4px 0; /* 上下のパディング */
      transition: color 0.2s; /* 色変化を滑らかに */
    }

    .nav-item:hover {
      color: #fff; /* ホバー時の色 */
    }

    .nav-text {
      font-size: 12px; /* テキストサイズ */
      margin-top: 2px; /* アイコンとテキストの間隔 (アイコンがない場合は調整) */
    }

    /* アクティブなタブのスタイル */
    .nav-item.active {
      color: #2ecc71; /* アクティブ時の色 (例: 緑) */
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1 class="page-title">Spot list</h1>
  <button class="open-btn" id="openModal">＋</button>

  <!-- タブナビゲーション -->
  <nav class="bottom-nav">
    <a href="index.html" class="nav-item active" id="nav-list">
      <span class="nav-text">リスト</span>
    </a>
    <a href="map_view.html" class="nav-item" id="nav-map">
      <span class="nav-text">マップ</span>
    </a>
    <a href="sort_spots.html" class="nav-item" id="nav-sort">
      <span class="nav-text">並び替え</span>
    </a>
  </nav>

  <!-- フィルター機能 -->
  <div class="filter-container">
    <!-- キーワード検索を1行目に単独で配置 -->
    <div class="filter-row">
      <div class="filter-item keyword-item">
        <label for="keywordFilter" class="filter-label">キーワード検索：</label>
        <input type="text" id="keywordFilter" class="filter-input" placeholder="スポット、住所、登録者名で検索可能">
      </div>
    </div>
    
    <!-- 2行目に都道府県とギルド状況を配置 -->
    <div class="filter-row">
      <div class="filter-item">
        <label for="prefectureFilter" class="filter-label">都道府県</label>
        <select id="prefectureFilter" class="filter-select">
          <option value="">すべて表示</option>
          <option value="北海道">北海道</option>
          <option value="青森県">青森県</option>
          <option value="岩手県">岩手県</option>
          <option value="宮城県">宮城県</option>
          <option value="秋田県">秋田県</option>
          <option value="山形県">山形県</option>
          <option value="福島県">福島県</option>
          <option value="茨城県">茨城県</option>
          <option value="栃木県">栃木県</option>
          <option value="群馬県">群馬県</option>
          <option value="埼玉県">埼玉県</option>
          <option value="千葉県">千葉県</option>
          <option value="東京都">東京都</option>
          <option value="神奈川県">神奈川県</option>
          <option value="新潟県">新潟県</option>
          <option value="富山県">富山県</option>
          <option value="石川県">石川県</option>
          <option value="福井県">福井県</option>
          <option value="山梨県">山梨県</option>
          <option value="長野県">長野県</option>
          <option value="岐阜県">岐阜県</option>
          <option value="静岡県">静岡県</option>
          <option value="愛知県">愛知県</option>
          <option value="三重県">三重県</option>
          <option value="滋賀県">滋賀県</option>
          <option value="京都府">京都府</option>
          <option value="大阪府">大阪府</option>
          <option value="兵庫県">兵庫県</option>
          <option value="奈良県">奈良県</option>
          <option value="和歌山県">和歌山県</option>
          <option value="鳥取県">鳥取県</option>
          <option value="島根県">島根県</option>
          <option value="岡山県">岡山県</option>
          <option value="広島県">広島県</option>
          <option value="山口県">山口県</option>
          <option value="徳島県">徳島県</option>
          <option value="香川県">香川県</option>
          <option value="愛媛県">愛媛県</option>
          <option value="高知県">高知県</option>
          <option value="福岡県">福岡県</option>
          <option value="佐賀県">佐賀県</option>
          <option value="長崎県">長崎県</option>
          <option value="熊本県">熊本県</option>
          <option value="大分県">大分県</option>
          <option value="宮崎県">宮崎県</option>
          <option value="鹿児島県">鹿児島県</option>
          <option value="沖縄県">沖縄県</option>
        </select>
      </div>

      <div class="filter-item">
        <label for="teamFilter" class="filter-label">ギルド状況</label>
        <select id="teamFilter" class="filter-select">
          <option value="">すべて表示</option>
          <option value="your guild">自ギルド</option>
          <option value="enemy">敵ギルド</option>
          <option value="neutral">未取得</option>
        </select>
      </div>
    </div>

    <!-- 3行目に拠点レベルと特定状況を配置 -->
    <div class="filter-row">
      <div class="filter-item">
        <label for="levelFilter" class="filter-label">拠点レベル</label>
        <select id="levelFilter" class="filter-select">
          <option value="">すべて表示</option>
          <option value="S">S</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
        </select>
      </div>

      <div class="filter-item">
        <label for="identifiedFilter" class="filter-label">特定状況</label>
        <select id="identifiedFilter" class="filter-select">
          <option value="">すべて表示</option>
          <option value="特定済み">特定済み</option>
          <option value="未特定">未特定</option>
        </select>
      </div>
    </div>
  </div>

  <!-- ローディングインジケーター -->
  <div id="loadingIndicator" class="loading-container">
    <div class="loading-spinner"></div>
    <p class="loading-text">データを読み込み中...</p>
  </div>

  <div class="spot-gallery" id="spotGallery"></div>

  <div class="modal-bg" id="modalBg">
    <div class="modal">
      <button class="close-btn" id="closeModal">×</button>
      <h1>📍 スポット登録</h1>
      <form id="spotForm">
        <label><span class="required-indicator">【必須】</span>画像アップロード</label>
        <input type="file" id="image" accept="image/*" required>

        <label>スポット名</label>
        <input type="text" id="name">

        <label for="latlng">緯度・経度</label> <small class="help-text">例: (35.6318549, 139.8809267)</small>
        <input type="text" id="latlng">

        <label>住所</label>
        <input type="text" id="address">

        <label>都道府県</label>
        <select id="prefecture">
          <option value="" selected class="default-option">選択してください</option>
          <option value="北海道">北海道</option>
          <option value="青森県">青森県</option>
          <option value="岩手県">岩手県</option>
          <option value="宮城県">宮城県</option>
          <option value="秋田県">秋田県</option>
          <option value="山形県">山形県</option>
          <option value="福島県">福島県</option>
          <option value="茨城県">茨城県</option>
          <option value="栃木県">栃木県</option>
          <option value="群馬県">群馬県</option>
          <option value="埼玉県">埼玉県</option>
          <option value="千葉県">千葉県</option>
          <option value="東京都">東京都</option>
          <option value="神奈川県">神奈川県</option>
          <option value="新潟県">新潟県</option>
          <option value="富山県">富山県</option>
          <option value="石川県">石川県</option>
          <option value="福井県">福井県</option>
          <option value="山梨県">山梨県</option>
          <option value="長野県">長野県</option>
          <option value="岐阜県">岐阜県</option>
          <option value="静岡県">静岡県</option>
          <option value="愛知県">愛知県</option>
          <option value="三重県">三重県</option>
          <option value="滋賀県">滋賀県</option>
          <option value="京都府">京都府</option>
          <option value="大阪府">大阪府</option>
          <option value="兵庫県">兵庫県</option>
          <option value="奈良県">奈良県</option>
          <option value="和歌山県">和歌山県</option>
          <option value="鳥取県">鳥取県</option>
          <option value="島根県">島根県</option>
          <option value="岡山県">岡山県</option>
          <option value="広島県">広島県</option>
          <option value="山口県">山口県</option>
          <option value="徳島県">徳島県</option>
          <option value="香川県">香川県</option>
          <option value="愛媛県">愛媛県</option>
          <option value="高知県">高知県</option>
          <option value="福岡県">福岡県</option>
          <option value="佐賀県">佐賀県</option>
          <option value="長崎県">長崎県</option>
          <option value="熊本県">熊本県</option>
          <option value="大分県">大分県</option>
          <option value="宮崎県">宮崎県</option>
          <option value="鹿児島県">鹿児島県</option>
          <option value="沖縄県">沖縄県</option>
        </select>

        <label><span class="required-indicator">【必須】</span>ギルド</label>
        <select id="team" required>
          <option value="" disabled selected class="default-option">選択してください</option>
          <option value="your guild">自ギルド（green）</option>
          <option value="enemy">敵ギルド（red）</option>
          <option value="neutral">未取得（white）</option>
        </select>

        <div id="enemyGuildNameContainer" class="hidden">
          <label>敵ギルド名</label>
          <input type="text" id="enemyGuildName">
        </div>

        <label><span class="required-indicator">【必須】</span>拠点レベル</label>
        <select id="level" required>
          <option value="" disabled selected class="default-option">選択してください</option>
          <option value="S">S</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
        </select>

        <label><span class="required-indicator">【必須】</span>登録者名</label>
        <input type="text" id="owner" required>

        <label><span class="required-indicator">【必須】</span>特定状況</label>
        <select id="identified" required>
          <option value="未特定" selected>未特定</option>
          <option value="特定済み">特定済み</option>
        </select>

        <!-- ▼▼▼ 追加 ▼▼▼ -->
        <label>100キロ圏内の都道府県</label>
        <input type="text" id="nearbyPrefectures" placeholder="例: 東京都,神奈川県,埼玉県">

        <label>Code</label>
        <input type="text" id="code" placeholder="例: ABC123">
        <!-- ▲▲▲ 追加 ▲▲▲ -->

        <button type="submit" style="margin-top: 16px;">送信</button>
      </form>
      <div id="result" style="margin-top: 10px; font-weight: bold;"></div>
    </div>
  </div>

  <script>
    const form = document.getElementById('spotForm');
    const teamSelect = document.getElementById('team');
    const enemyGuildNameContainer = document.getElementById('enemyGuildNameContainer');
    const resultBox = document.getElementById('result');

    const openBtn = document.getElementById('openModal');
    const closeBtn = document.getElementById('closeModal');
    const modalBg = document.getElementById('modalBg');

    openBtn.onclick = () => modalBg.style.display = 'flex';
    closeBtn.onclick = () => modalBg.style.display = 'none';

    // ★★★ モーダル外クリックで閉じる処理 (新規・編集 共通) ★★★
    window.addEventListener('click', (event) => {
      // クリックされた要素がモーダルの背景 (.modal-bg) かどうかをチェック
      if (event.target.classList.contains('modal-bg')) {
         // 背景をクリックしたら、そのモーダルを非表示にする
         event.target.style.display = 'none';
         console.log(`モーダル ${event.target.id || '(IDなし)'} を背景クリックで閉じました。`);
      }
    });

    teamSelect.addEventListener('change', () => {
      enemyGuildNameContainer.classList.toggle('hidden', teamSelect.value !== 'enemy');
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault(); // デフォルトの送信をキャンセル
      resultBox.innerText = ''; // 前回のメッセージをクリア

      // --- ▼▼▼ バリデーションチェックを追加 ▼▼▼ ---
      let errors = [];
      const imageInput = document.getElementById('image');
      const teamSelect = document.getElementById('team');
      const levelSelect = document.getElementById('level');
      const ownerInput = document.getElementById('owner');
      const identifiedSelect = document.getElementById('identified');
      const latlngInput = document.getElementById('latlng'); // 任意だが形式チェック用
      // ▼▼▼ 追加 ▼▼▼
      const nearbyPrefecturesInput = document.getElementById('nearbyPrefectures');
      const codeInput = document.getElementById('code');
      // ▲▲▲ 追加 ▲▲▲

      // 1. 画像 (必須)
      if (imageInput.files.length === 0) {
        errors.push('・画像を選択してください。');
      } else if (imageInput.files[0].size > 5 * 1024 * 1024) {
        errors.push('・画像サイズは5MB以下にしてください。');
      }

      // 2. ギルド (必須)
      if (teamSelect.value === "") { // value="" の「選択してください」が選ばれていないか
        errors.push('・ギルドを選択してください。');
      }

      // 3. 拠点レベル (必須)
      if (levelSelect.value === "") { // value="" の「選択してください」が選ばれていないか
        errors.push('・拠点レベルを選択してください。');
      }

      // 4. 登録者名 (必須)
      if (ownerInput.value.trim() === '') {
        errors.push('・登録者名を入力してください。');
      }

      // 5. 特定状況 (必須) - value="" がないので選択されていればOK
      if (!identifiedSelect.value) {
          errors.push('・特定状況を選択してください。'); // 通常発生しないはず
      }

      // 6. 緯度・経度 (任意だが、入力があれば形式チェック)
      const latlngValue = latlngInput.value.trim();
      if (latlngValue !== '') { // 入力がある場合のみチェック
          const latlngParts = latlngValue.replace(/[()\s]/g, '').split(',');
          if (latlngParts.length !== 2 || isNaN(parseFloat(latlngParts[0])) || isNaN(parseFloat(latlngParts[1]))) {
              errors.push('・緯度・経度の形式が正しくありません (例: 35.6, 139.8)。');
          }
      }
      // --- ▲▲▲ バリデーションチェックここまで ▲▲▲ ---

      // エラーがあれば表示して送信を中止
      if (errors.length > 0) {
        resultBox.innerHTML = `<div style="color: #ff6b6b; text-align: left; margin: 10px 0;">
          <strong>⚠️ 以下の項目を確認してください：</strong><br>
          ${errors.join('<br>')}
        </div>`;
        return;
      }

      // フォームデータの作成
      const formData = new FormData();
      formData.append('imageFile', imageInput.files[0]);
      formData.append('name', document.getElementById('name').value);
      formData.append('latlng', latlngInput.value);
      formData.append('address', document.getElementById('address').value);
      formData.append('prefecture', document.getElementById('prefecture').value);
      formData.append('team', teamSelect.value);
      formData.append('enemyGuildName', document.getElementById('enemyGuildName').value);
      formData.append('level', levelSelect.value);
      formData.append('owner', ownerInput.value);
      formData.append('identified', identifiedSelect.value);
      // ▼▼▼ 追加 ▼▼▼
      formData.append('nearbyPrefectures', nearbyPrefecturesInput.value);
      formData.append('code', codeInput.value);
      // ▲▲▲ 追加 ▲▲▲

      // --- バリデーション通過後: 送信処理 ---
      resultBox.innerText = '⏳ 登録処理中...';
      resultBox.style.color = ''; // メッセージの色を元に戻す
      resultBox.style.whiteSpace = ''; // 改行設定を元に戻す

      const image = imageInput.files[0];
      const reader = new FileReader();

      reader.onload = async function () {
        const base64Image = reader.result.split(',')[1];
        if (!base64Image) {
          resultBox.innerText = '❌ エラー: 画像データの読み込みに失敗しました';
          return;
        }

        // 緯度経度はバリデーション済みなので、再度取得して使う
        const latlngValue = document.getElementById('latlng').value.trim();
        const finalLatLng = latlngValue === '' ? ['', ''] : latlngValue.replace(/[()\s]/g, '').split(',');

        // --- ▼▼▼ スポット名が空なら「スポット不明」を設定 ▼▼▼ ---
        let spotName = document.getElementById('name').value.trim();
        if (spotName === '') {
            spotName = 'スポット不明'; // デフォルトの名前を設定
            console.log('スポット名が未入力のため「スポット不明」を設定しました。');
        }
        // --- ▲▲▲ ここまで追加 ▲▲▲ ---

        const formData = new URLSearchParams();
        formData.append('imageFile', base64Image);
        formData.append('imageType', image.type);
        formData.append('name', spotName); // ★ 修正: spotName 変数を使う
        formData.append('lat', parseFloat(finalLatLng[0] || "0").toString()); // 任意項目
        formData.append('lng', parseFloat(finalLatLng[1] || "0").toString()); // 任意項目
        formData.append('address', document.getElementById('address').value); // 任意項目
        formData.append('prefecture', document.getElementById('prefecture').value); // 任意項目
        formData.append('team', teamSelect.value); // 必須項目
        formData.append('enemyGuildName', document.getElementById('enemyGuildName').value); // 任意項目
        formData.append('level', levelSelect.value); // 必須項目
        formData.append('owner', ownerInput.value); // 必須項目
        formData.append('identified', identifiedSelect.value); // 必須項目
        formData.append('displayOrder', '999999'); // 新規登録時は最大値を使用

        // デバッグログ：送信データの確認
        console.log("📝 新規登録 - 送信データ:", {
          name: spotName, // ★ 修正: spotName 変数を使う
          lat: parseFloat(finalLatLng[0] || "0"),
          lng: parseFloat(finalLatLng[1] || "0"),
          address: document.getElementById('address').value,
          prefecture: document.getElementById('prefecture').value,
          team: teamSelect.value,
          enemyGuildName: document.getElementById('enemyGuildName').value,
          level: levelSelect.value,
          owner: ownerInput.value,
          identified: identifiedSelect.value,
          displayOrder: '999999' // デバッグログにも表示順を追加
        });

        try {
          const response = await fetch('https://script.google.com/macros/s/AKfycbx7slBtDJzVH3PYnSHW5MIgjEvm2XJAWBVN9RO05ALNgxMnyBDGS608OuEHBGBhi_aPJw/exec', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: formData.toString() // URLSearchParamsを明示的に文字列化
          });

          // レスポンスのステータスコードをチェック
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          // レスポンステキストを取得
          const text = await response.text();
          let result;

          try {
            result = JSON.parse(text);
          } catch (e) {
            console.error('JSONパースエラー:', e);
            console.error('受信したテキスト:', text);
            throw new Error(`サーバーから無効なレスポンスを受け取りました: ${text}`);
          }

          if (result.result === "error") {
            throw new Error(result.message || "登録に失敗しました");
          }

          // ✅ 成功時の処理
          resultBox.innerText = '✅ 登録しました！表示を更新します...';
          form.reset();
          
          // ★★★ モーダルを閉じてローディング表示 & 更新 ★★★
          modalBg.style.display = 'none'; // 新規登録モーダルを閉じる
          const loadingIndicator = document.getElementById('loadingIndicator');
          if (loadingIndicator) loadingIndicator.style.display = 'flex'; // ローディング表示
          await loadSpots(); // データ再読み込み実行
        } catch (error) {
          console.error('登録エラー:', error);
          resultBox.innerText = `❌ エラー: ${error.message || '登録に失敗しました'}`;
          // エラー時はモーダルを閉じない（ユーザーが再試行できるように）
        }
      };

      reader.onerror = function() {
        resultBox.innerText = '❌ エラー: 画像の読み込みに失敗しました';
      };

      reader.readAsDataURL(image);
    });
  </script>

  <script>
    // --- グローバル変数 ---
    window.spotDataArray = [];      // 表示順でソート済みのデータ配列
    window.selectedFilters = {
      keyword: '',
      prefecture: '',
      team: '',
      identified: '',
      level: ''
    };

    // --- loadSpots 関数の修正 ---
    async function loadSpots() {
      // ローディングインジケーターを表示
      const loadingIndicator = document.getElementById('loadingIndicator');
      loadingIndicator.style.display = 'flex';
      
      try {
        // キャッシュ問題を回避するためのタイムスタンプパラメータを追加
        const timestamp = new Date().getTime();
        const sheetUrl = `https://docs.google.com/spreadsheets/d/1XWirleOXBpzKw-cvyl_FVbfoqhCiXmYCefoAFJzZMd8/gviz/tq?tqx=out:json&_=${timestamp}`;
        
        console.log('📥 スプレッドシートからデータを取得中...');
        const res = await fetch(sheetUrl, { 
          cache: 'no-store'  // キャッシュを使用しない
        });
        
        const text = await res.text();
        const json = JSON.parse(text.replace("/*O_o*/\ngoogle.visualization.Query.setResponse(", "").slice(0, -2));
        
        // スプレッドシートの順序通りに表示
        const rows = json.table.rows;
        console.log(`📊 gviz API応答: ${rows ? rows.length : 0} 行のデータを取得しました。`);

        if (!rows) {
          console.error("❌ gviz APIから行データ(rows)が取得できませんでした。");
          // エラーメッセージを表示
          const gallery = document.getElementById("spotGallery");
          gallery.innerHTML = '<div class="error-message">データの取得に失敗しました。しばらく経ってからページを再読み込みしてください。</div>';
          return;
        }

        // 有効なデータのみをフィルタリング
        const validRows = [];
        const invalidRowsInfo = []; // 除外された行の情報を格納

        rows.forEach((row, index) => {
          let isValid = false;
          let reason = '不明';

          if (row && row.c) {
            const id = row.c[0] ? row.c[0].v : null; // A列の値
            const name = row.c[1] ? row.c[1].v : null; // B列の値
            const displayOrder = row.c[14] ? row.c[14].v : null; // O列の値

            // 元のフィルタリング条件
            const hasId = id !== null && id !== '';
            const hasName = name !== null && name !== '';
            const hasDisplayOrder = displayOrder !== null && displayOrder !== ''; // 空白もチェック

            isValid = hasId && hasName && hasDisplayOrder;

            if (!isValid) {
              // 除外理由を特定
              if (!hasId) reason = 'ID(A列)が空またはnull';
              else if (!hasName) reason = 'スポット名(B列)が空またはnull';
              else if (!hasDisplayOrder) reason = '表示順(O列)が空またはnull';
              else reason = 'その他の理由（データ形式など）';

              // 除外情報を記録
              invalidRowsInfo.push({
                sheetRow: index + 2, // スプレッドシート上の行番号 (ヘッダ除く)
                idValue: id,
                nameValue: name,
                displayOrderValue: displayOrder,
                exclusionReason: reason
              });
            }
          } else {
            // row または row.c が null の場合
            reason = '行データ自体がnullまたは不正';
            invalidRowsInfo.push({
              sheetRow: index + 2,
              idValue: 'N/A',
              nameValue: 'N/A',
              displayOrderValue: 'N/A',
              exclusionReason: reason
            });
          }

          if (isValid) {
            validRows.push(row); // 有効な行のみ追加
          }
        });

        // 除外された行があればその情報を表示
        if (invalidRowsInfo.length > 0) {
          console.warn(`⚠️ ${invalidRowsInfo.length} 件の行がフィルタリングで除外されました。詳細は以下の通り:`);
          console.table(invalidRowsInfo); // テーブル形式で見やすく表示
        } else if (rows.length > 0) {
          console.log("✅ すべての行がフィルタリング条件を満たしました。");
        }

        console.log(`🔢 最終的な有効スポット数 (表示対象): ${validRows.length} 件`);
        
        // ★★★ 常に表示順 (O列) でソート ★★★
        validRows.sort((a, b) => {
          const orderA = (a.c && a.c[14] && !isNaN(parseInt(a.c[14].v))) ? parseInt(a.c[14].v) : Number.MAX_SAFE_INTEGER;
          const orderB = (b.c && b.c[14] && !isNaN(parseInt(b.c[14].v))) ? parseInt(b.c[14].v) : Number.MAX_SAFE_INTEGER;
          return orderA - orderB;
        });
        console.log("🔄 初期ソート: 表示順 (O列) でソートしました。");

        // グローバル配列としてスポットデータを保持（表示順ソート済み）
        window.spotDataArray = validRows.map(row => { // validRows を変換して spotDataArray を作成
          const id = row.c[0]?.v || "";
          const name = row.c[1]?.v || "";
          const lat = parseFloat(row.c[2]?.v || "0");
          const lng = parseFloat(row.c[3]?.v || "0");
          const address = row.c[4]?.v || "";
          const prefecture = row.c[5]?.v || "";
          const team = row.c[6]?.v || "neutral";
          const enemyGuildName = row.c[7]?.v || "";
          const level = row.c[8]?.v || "";
          const owner = row.c[9]?.v || "";
          const identified = row.c[10]?.v || "未特定";
          const imageUrl = row.c[11]?.v || "";
          const base64Data = row.c[13]?.v || ""; // 変数名を base64Data に変更
          const displayOrder = parseInt(row.c[14]?.v) || Number.MAX_SAFE_INTEGER;
          
          // ▼▼▼ 新しい項目をここでも取得してオブジェクトに含める ▼▼▼
          const nearbyPrefectures = row.c[15]?.v || ""; // P列
          const code = row.c[16]?.v || "";             // Q列
          // ▲▲▲ ▲▲▲

          return {
              id, name, lat, lng, address, prefecture, team, enemyGuildName,
              level, owner, identified, imageUrl, imageBase64: base64Data, // imageBase64 プロパティに格納
              displayOrder,
              nearbyPrefectures, // 追加
              code               // 追加
          };
      });

        // 初期表示のためにフィルター適用
        applyCombinedFilters();
      } catch (error) {
        console.error('データ読み込みエラー:', error);
        // エラーメッセージを表示
        const gallery = document.getElementById("spotGallery");
        gallery.innerHTML = `<div class="error-message">データの取得に失敗しました: ${error.message}<br>しばらく経ってからページを再読み込みしてください。</div>`;
      } finally {
        // ローディングインジケーターを非表示
        loadingIndicator.style.display = 'none';
      }
    }

    // --- applyCombinedFilters 関数の修正 ---
    function applyCombinedFilters() {
      const gallery = document.getElementById("spotGallery");
      gallery.innerHTML = "";

      // const { keyword, prefecture, team, identified, level } = window.selectedFilters; // window.selectedFiltersから直接参照するためコメントアウト

      if (!window.spotDataArray || !Array.isArray(window.spotDataArray)) {
        console.error("フィルター適用エラー: window.spotDataArray が不正です。");
        return;
      }

      // 1. 絞り込みフィルターを適用 (表示順ソート済み配列に対して)
      const filtered = window.spotDataArray.filter(spot => {
        let match = true;

        // キーワード検索フィルター
        if (window.selectedFilters.keyword && window.selectedFilters.keyword.trim() !== '') {
          const searchTerm = window.selectedFilters.keyword.trim().toLowerCase();
          // spot オブジェクトのプロパティを小文字にして検索
          const name = (spot.name || "").toLowerCase();
          const address = (spot.address || "").toLowerCase();
          const spotPrefecture = (spot.prefecture || "").toLowerCase(); // 変数名を spot.prefecture と区別
          const enemyGuildName = (spot.enemyGuildName || "").toLowerCase();
          const owner = (spot.owner || "").toLowerCase();
          const code = (String(spot.code || "")).toLowerCase(); // <<< 修正点: String() で明示的に文字列に変換
          
          match = match && (
            name.includes(searchTerm) || 
            address.includes(searchTerm) ||
            spotPrefecture.includes(searchTerm) || // 修正: spot.prefecture の内容を使用
            enemyGuildName.includes(searchTerm) ||
            owner.includes(searchTerm) ||
            code.includes(searchTerm) // <<< 追加
          );
        }
        
        // 都道府県フィルター
        if (window.selectedFilters.prefecture) {
          match = match && spot.prefecture === window.selectedFilters.prefecture;
        }

        // ギルドフィルター
        if (window.selectedFilters.team) {
          match = match && spot.team === window.selectedFilters.team;
        }
        
        // 特定状況フィルター
        if (window.selectedFilters.identified) {
          match = match && spot.identified === window.selectedFilters.identified;
        }

        // レベルフィルター
        if (window.selectedFilters.level) {
          match = match && spot.level === window.selectedFilters.level;
        }

        return match;
      });

      console.log('絞り込みフィルター適用後の件数:', filtered.length);

      // 2. カードを描画
      let cardCount = 0;
      filtered.forEach((spot, i) => { // filtered の各要素 spot は既に必要なデータを持つオブジェクト
          cardCount++;

          // spot オブジェクトから直接データを取得（デストラクト名を変更）
          const {
              id, name, lat, lng, address, 
              prefecture: spotPref, // prefecture のデストラクト名を spotPref に変更
              team: spotTeam, // team のデストラクト名を spotTeam に変更
              level: spotLevel, // level のデストラクト名を spotLevel に変更
              owner: spotOwner, // owner のデストラクト名を spotOwner に変更
              identified: spotIdentified, // identified のデストラクト名を spotIdentified に変更
              imageUrl, imageBase64, // imageBase64 はこの名前でデストラクト
              displayOrder,
              nearbyPrefectures, // 追加
              code               // 追加
          } = spot;

          const originalIndexInFull = window.spotDataArray.findIndex(originalSpot => originalSpot.id === id);
          const rowIndex = originalIndexInFull !== -1 ? originalIndexInFull + 2 : i + 2; // シート上の行番号に近い値

          const dataForCard = { // setupModalEvent に渡すデータ
              id, rowIndex, name, lat, lng, 
              team: spotTeam, // デストラクトした変数を使用
              level: spotLevel, // デストラクトした変数を使用
              imageUrl, address, 
              prefecture: spotPref, // デストラクトした変数を使用
              enemyGuildName: spot.enemyGuildName, // spotから直接アクセスも可
              owner: spotOwner, // デストラクトした変数を使用
              imageBase64: imageBase64, // ★★★ ここを修正: imageBase64 を使用 ★★★
              identified: spotIdentified, // デストラクトした変数を使用
              displayOrder,
              nearbyPrefectures, // 追加
              code               // 追加
          };

          const card = document.createElement("div");
          card.className = "spot-card";
          card.setAttribute('data-id', id);
          card.setAttribute('data-row-index', rowIndex); // 削除や編集のために行番号も保持

          const img = document.createElement("img");
          img.alt = name;
          img.setAttribute('referrerpolicy', 'no-referrer');

          // 画像ソースの設定 (Base64優先)
          if (imageBase64 && imageBase64.length > 100) { // imageBase64 を使用
            img.src = `data:image/jpeg;base64,${imageBase64}`;
          } else if (imageUrl) { // なければDriveのURL
            img.src = imageUrl;
            img.onerror = function () { // エラー処理
              img.src = ""; // 画像URLが無効なら非表示
              img.alt = "画像が読み込めません";
            };
          } else { // どちらもなければ
            img.src = "";
            img.alt = "画像がありません";
          }

          // 画像にオーバーレイ効果を追加
          if (spotTeam === "your guild" || spotTeam === "enemy") { // spotTeam を使用
            const overlay = document.createElement("div");
            overlay.className = "card-overlay";
            if (spotTeam === "your guild") overlay.classList.add("overlay-green");
            else if (spotTeam === "enemy") overlay.classList.add("overlay-red");
            card.appendChild(overlay);
          }

          card.appendChild(img); // 画像をカードに追加

          // 左上 → level
          if (spotLevel) { // spotLevel を使用
            const levelBadge = document.createElement("div");
            let levelClass = "";
            switch(spotLevel) {
              case "S": levelClass = "s-rank"; break;
              case "A": levelClass = "a-rank"; break;
              case "B": levelClass = "b-rank"; break;
              case "C": levelClass = "c-rank"; break;
              case "D": levelClass = "d-rank"; break;
              default: levelClass = "";
            }
            levelBadge.className = `badge level ${levelClass}`;
            levelBadge.textContent = spotLevel;
            levelBadge.style.left = "6px";
            levelBadge.style.top = "6px";
            card.appendChild(levelBadge);
          }

          // 右上 → 都道府県
          if (spotPref) { // spotPref を使用
            const prefTag = document.createElement("div");
            prefTag.className = "pref-tag";
            prefTag.textContent = spotPref;
            card.appendChild(prefTag);
          }

          // 左下 → 特定状況
          const identifiedBadge = document.createElement("div");
          identifiedBadge.className = `badge ${spotIdentified === "特定済み" ? "blue" : "gray"}`; // spotIdentified を使用
          identifiedBadge.textContent = spotIdentified === "特定済み" ? "特定" : "未特";
          identifiedBadge.style.bottom = "6px";
          identifiedBadge.style.left = "6px";
          identifiedBadge.style.top = "auto";
          card.appendChild(identifiedBadge);

          // 右下 → ギルド(team)
          if (spotTeam === "your guild" || spotTeam === "enemy") { // spotTeam を使用
            const guildBadge = document.createElement("div");
            guildBadge.className = `badge ${spotTeam === "your guild" ? "green" : "red"}`;
            let teamText = (spotTeam === "your guild") ? "自軍" : "敵陣";
            guildBadge.textContent = teamText;
            guildBadge.style.bottom = "6px";
            guildBadge.style.right = "6px";
            guildBadge.style.top = "auto";
            guildBadge.style.left = "auto";
            card.appendChild(guildBadge);
          }

          gallery.appendChild(card); // ★★★ これが重要！ギャラリーにカードを追加 ★★★
          setupModalEvent(card, dataForCard); // モーダル表示用のイベント設定
      });

      console.log("🎨 描画完了。 カード数:", cardCount);
    }

    // モーダル表示のイベント設定
    function setupModalEvent(card, spotData) {
      card.addEventListener('click', () => {
        const modal = document.getElementById('spotModal');
        
        // モーダルにデータを設定
        document.getElementById('modal-image').src = spotData.imageBase64 
          ? `data:image/jpeg;base64,${spotData.imageBase64}` 
          : (spotData.imageUrl || '');
        
        document.getElementById('modalNameInput').value = spotData.name || '';
        document.getElementById('modalLatLngInput').value = `(${spotData.lat}, ${spotData.lng})`;
        document.getElementById('modalAddressInput').value = spotData.address || '';
        document.getElementById('modalPrefectureInput').value = spotData.prefecture || '';
        document.getElementById('modalTeamInput').value = spotData.team || 'neutral';
        document.getElementById('modalEnemyGuildInput').value = spotData.enemyGuildName || '';
        document.getElementById('modalLevelInput').value = spotData.level || '';
        document.getElementById('modalOwnerInput').value = spotData.owner || '';
        document.getElementById('modalIdentifiedInput').value = spotData.identified || '未特定';
        
        // ▼▼▼ 追加 ▼▼▼
        document.getElementById('modalNearbyPrefecturesInput').value = spotData.nearbyPrefectures || '';
        document.getElementById('modalCodeInput').value = spotData.code || '';
        // ▲▲▲ 追加 ▲▲▲
        
        // データを属性としてモーダルに保存
        modal.dataset.spotData = JSON.stringify(spotData);
        
        // モーダルを表示
        modal.style.display = 'flex';
      });
    }

    // --- イベントリスナー ---
    document.getElementById('keywordFilter').addEventListener('input', (e) => {
      window.selectedFilters.keyword = e.target.value;
      applyCombinedFilters();
    });

    document.getElementById('prefectureFilter').addEventListener('change', (e) => {
      window.selectedFilters.prefecture = e.target.value;
      applyCombinedFilters();
    });

    document.getElementById('teamFilter').addEventListener('change', (e) => {
      window.selectedFilters.team = e.target.value;
      applyCombinedFilters();
    });

    document.getElementById('identifiedFilter').addEventListener('change', (e) => {
      window.selectedFilters.identified = e.target.value;
      applyCombinedFilters();
    });

    document.getElementById('levelFilter').addEventListener('change', (e) => {
      window.selectedFilters.level = e.target.value;
      applyCombinedFilters();
    });

    // --- 初期表示処理 ---
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        await loadSpots();
        console.log("💾 初期データ読み込み完了: 有効なスポット数 =", window.spotDataArray?.length || 0);
        applyCombinedFilters();
      } catch (error) {
        console.error("初期データ読み込みエラー:", error);
      }
    });
  </script>

  <!-- 詳細モーダル（最初は非表示） -->
  <div id="spotModal" class="modal-bg">
    <div class="modal-view">
      <span class="modalCloseButton">&times;</span>
      <img id="modal-image" class="modal-image" alt="Spot Image" />
      <div class="modal-details">
        <p><strong>スポット名:</strong> <input id="modalNameInput" type="text" class="modal-input" placeholder="スポット名" /></p>
        <p><strong>緯度・経度:</strong> <input id="modalLatLngInput" type="text" class="modal-input" placeholder="例: (33.6219287, 130.4381177)" /></p>
        <p><strong>住所:</strong> <input id="modalAddressInput" type="text" class="modal-input" placeholder="住所" /></p>
        <p><strong>都道府県:</strong> <select id="modalPrefectureInput" class="modal-input">
          <option value="">選択してください</option>
          <option value="北海道">北海道</option>
          <option value="青森県">青森県</option>
          <option value="岩手県">岩手県</option>
          <option value="宮城県">宮城県</option>
          <option value="秋田県">秋田県</option>
          <option value="山形県">山形県</option>
          <option value="福島県">福島県</option>
          <option value="茨城県">茨城県</option>
          <option value="栃木県">栃木県</option>
          <option value="群馬県">群馬県</option>
          <option value="埼玉県">埼玉県</option>
          <option value="千葉県">千葉県</option>
          <option value="東京都">東京都</option>
          <option value="神奈川県">神奈川県</option>
          <option value="新潟県">新潟県</option>
          <option value="富山県">富山県</option>
          <option value="石川県">石川県</option>
          <option value="福井県">福井県</option>
          <option value="山梨県">山梨県</option>
          <option value="長野県">長野県</option>
          <option value="岐阜県">岐阜県</option>
          <option value="静岡県">静岡県</option>
          <option value="愛知県">愛知県</option>
          <option value="三重県">三重県</option>
          <option value="滋賀県">滋賀県</option>
          <option value="京都府">京都府</option>
          <option value="大阪府">大阪府</option>
          <option value="兵庫県">兵庫県</option>
          <option value="奈良県">奈良県</option>
          <option value="和歌山県">和歌山県</option>
          <option value="鳥取県">鳥取県</option>
          <option value="島根県">島根県</option>
          <option value="岡山県">岡山県</option>
          <option value="広島県">広島県</option>
          <option value="山口県">山口県</option>
          <option value="徳島県">徳島県</option>
          <option value="香川県">香川県</option>
          <option value="愛媛県">愛媛県</option>
          <option value="高知県">高知県</option>
          <option value="福岡県">福岡県</option>
          <option value="佐賀県">佐賀県</option>
          <option value="長崎県">長崎県</option>
          <option value="熊本県">熊本県</option>
          <option value="大分県">大分県</option>
          <option value="宮崎県">宮崎県</option>
          <option value="鹿児島県">鹿児島県</option>
          <option value="沖縄県">沖縄県</option>
        </select></p>
        <p><strong>ギルド種別:</strong> <select id="modalTeamInput" class="modal-input modal-select-small">
          <option value="neutral" class="default-option">未取得（white）</option>
          <option value="your guild">自ギルド（green）</option>
          <option value="enemy">敵ギルド（red）</option>
        </select></p>
        <p><strong>敵ギルド名:</strong> <input id="modalEnemyGuildInput" type="text" class="modal-input" placeholder="敵ギルド名" /></p>
        <p><strong>拠点レベル:</strong> <select id="modalLevelInput" class="modal-input modal-select-small">
          <option value="" disabled selected class="default-option">選択してください</option>
          <option value="S">S</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
        </select></p>
        <p><strong>登録者:</strong> <input id="modalOwnerInput" type="text" class="modal-input" placeholder="登録者名" /></p>
        <p><strong>特定状況:</strong> <select id="modalIdentifiedInput" class="modal-input modal-select-small">
          <option value="未特定">未特定</option>
          <option value="特定済み">特定済み</option>
        </select></p>

        <p><strong>100キロ圏内の都道府県:</strong> <input id="modalNearbyPrefecturesInput" type="text" class="modal-input" placeholder="例: 東京都, 神奈川県" /></p>
        <p><strong>Code:</strong> <input id="modalCodeInput" type="text" class="modal-input" placeholder="コードを入力" /></p>
      </div>
      <div class="modal-buttons">
        <button id="saveSpotButton" class="save-button">保存</button>
        <button id="deleteSpotButton" class="delete-button">削除</button>
      </div>
    </div>
  </div>

  <script>
    // モーダルの閉じるボタンの処理
    document.querySelectorAll(".modalCloseButton").forEach(button => {
      button.addEventListener("click", () => {
        const modal = button.closest(".modal-bg");
        modal.style.display = "none";
      });
    });
  </script>
<script>
  // 保存と削除ボタンのイベントリスナーを追加
  document.addEventListener('DOMContentLoaded', () => {
    // 保存ボタンの処理
    document.getElementById('saveSpotButton').addEventListener('click', async () => {
      try {
        const modal = document.getElementById('spotModal');
        const spotData = JSON.parse(modal.dataset.spotData || '{}');
        
        // const identifiedSelect = document.getElementById('modalIdentifiedInput'); // 旧コード
        // (identifiedSelectのログは変更なし) // 旧コードに関連するコメント
        
        const name = document.getElementById('modalNameInput').value;
        const latLngInput = document.getElementById('modalLatLngInput').value;
        const latLng = latLngInput.replace(/[()]/g, '').split(',').map(s => s.trim());
        const lat = parseFloat(latLng[0]);
        const lng = parseFloat(latLng[1]);
        const address = document.getElementById('modalAddressInput').value;
        const prefecture = document.getElementById('modalPrefectureInput').value;
        const team = document.getElementById('modalTeamInput').value;
        const enemyGuildName = document.getElementById('modalEnemyGuildInput').value;
        const level = document.getElementById('modalLevelInput').value;
        const owner = document.getElementById('modalOwnerInput').value;
        
        // ▼▼▼ 値取得とデバッグログの確認 ▼▼▼
        const nearbyPrefecturesElement = document.getElementById('modalNearbyPrefecturesInput');
        const codeElement = document.getElementById('modalCodeInput');

        const nearbyPrefectures = nearbyPrefecturesElement ? nearbyPrefecturesElement.value : ''; // .value を確認、要素存在チェック追加
        const code = codeElement ? codeElement.value : '';                         // .value を確認、要素存在チェック追加

        console.log('Debug: nearbyPrefecturesElement is:', nearbyPrefecturesElement); 
        console.log('Debug: nearbyPrefectures value is:', nearbyPrefectures, '(type:', typeof nearbyPrefectures, ')');
        console.log('Debug: codeElement is:', codeElement);
        console.log('Debug: code value is:', code, '(type:', typeof code, ')');
        // ▲▲▲ 値取得とデバッグログの確認 ▲▲▲
        
        let identified = document.getElementById('modalIdentifiedInput').value; // identified も同様に .value で取得
        
        // identifiedのフォールバック処理 (もしselect要素が空の可能性がある場合など、必要に応じて残す)
        if (!identified || identified === '') {
          identified = spotData.identified || '未特定'; // spotDataからのフォールバック
          console.log("⚠️ identifiedが空のためフォールバック適用:", identified);
        }
        
        // (必須項目チェックは変更なし)
        if (!name) {
          alert('スポット名は必須項目です');
          return;
        }
        if (isNaN(lat) || isNaN(lng)) {
          alert('緯度・経度の形式が正しくありません');
          return;
        }
  
        const formData = new URLSearchParams();
        formData.append('id', spotData.id);
        formData.append('rowIndex', spotData.rowIndex);
        formData.append('name', name);
        formData.append('lat', lat);
        formData.append('lng', lng);
        formData.append('address', address);
        formData.append('prefecture', prefecture);
        formData.append('team', team);
        formData.append('enemyGuildName', enemyGuildName);
        formData.append('level', level);
        formData.append('owner', owner);
        formData.append('identified', identified);
        formData.append('displayOrder', spotData.displayOrder);

        // 4. formData に追加する変数の値を確認
        formData.append('nearbyPrefectures', nearbyPrefectures); 
        formData.append('code', code);                         
  
        console.log('📝 更新 - 送信されるformDataの全内容:');
        for (const pair of formData.entries()) {
          console.log(`  ${pair[0]}: ${pair[1]}`);
        }

        // (try...catch...finally ブロック内の fetch 処理は前回の提案のまま)
        try {
          const apiEndpoint = 'https://script.google.com/macros/s/AKfycbx7slBtDJzVH3PYnSHW5MIgjEvm2XJAWBVN9RO05ALNgxMnyBDGS608OuEHBGBhi_aPJw/exec'; // ★ご自身のGAS URLに要変更
          const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
          const fetchOptions = {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: formData.toString(),
            mode: 'no-cors' 
          };
          
          console.log('🌐 サーバーリクエスト送信 - モード:', fetchOptions.mode);
          
          let alertMessage = null;
          const currentModal = document.getElementById('spotModal'); 

          try {
            await fetch(apiEndpoint, fetchOptions);
            alertMessage = '✅ 更新リクエストを送信しました。データはスプレッドシート側で処理されているはずです。';

          } catch (fetchError) {
            console.error('🔍 フェッチエラー:', fetchError);
            alertMessage = `❌ リクエスト送信エラー: ${fetchError.message || 'ネットワーク接続などを確認してください'}`;
          } finally {
            if (alertMessage) alert(alertMessage);
            currentModal.style.display = 'none'; 

            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) loadingIndicator.style.display = 'flex';
            await loadSpots();
          }
        } catch (error) {
          console.error('🔍 エラー詳細:', error);
          alert(`❌ エラー: ${error.message || '更新に失敗しました'}`);
        }
      } catch (error) {
        console.error('更新エラー:', error);
        alert(`❌ エラー: ${error.message || '更新に失敗しました'}`);
      }
    });
    // (削除ボタンの処理は省略)
  });
</script>
</body>
</html>
